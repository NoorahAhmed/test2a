<?xml version="1.0" encoding="US-ASCII"?>
<!DOCTYPE trf-dependencies>

<!--
    Custom helper template for Action: z_receipt_helper_templates_v14

    Newest version on top, fill all columns if applicable.
    Date        Version     Author       Topdesk       Jira        Description
    17-04-2024  3.21        EJACOBS                    XV-20569    Aantal artikelen on receipt are incorrect with return and "combi-bonnen"
    25-03-2024  3.20        MVROSS       CTCR23080097  XV-17884    Footer text Cancellation and Returns receipt customer order 2.0 not correct
    14-03-2024  3.19        MVROSS       CTCR23080348  XV-19901    Selling Set Deposit article > unclear receipt
    30-01-2024  3.18        KHA/MEP      CTCR21120490  XV-14135    Brief description Return met bonnummer retour filiaal
    08-09-2023  3.17        JLO          CTAC23090362              Adding documenttype z_b2c as a value like z_invoice and direct_sales
    05-06-2023  3.16        SLINDE       CTCR22100127  XV-16524    No label text when document type is z_b2c
    22-02-2023  3.15        SGEIJN       CTCR22040358  XV-15928    Add support for a barcode specific to the short receipt.
    15-02-2023  3.14        SGEIJN       CTCR22040358  XV-15876    Merge DEV and PRJ scripts, added parameters and templates for short receipt.
    03-11-2022  3.13        JLO          CTCR21060180              Added Phone as partner prefix
    22-07-2022  3.12        JLO          CTCR21060180              Small changes customer order IT requirements
    30-06-2022  3.11        LCO          CTCR21060180  XV-14636    Added support for cancelling orders
    03-03-2022  3.10        SNAGTZ       CTCR22030093              Exclude deposit/pfand articles from quantity summary
    07-01-2022  3.9         JLO          CTCR21120149              Change title header in case of Invoice
    03-01-2022  3.8         MABELI       CTCR21080673  XV-13964    Change Quantity summary / layout number purchases
    24-11-2021  3.7         TKUST        CTCR21060519              Adding fields Name2 en Name3
    18-10-2021  3.6         SNAGTZ                     XV-13710    Customize ticket template for Catalunya (spain)
    11-08-2021  3.5         JLO          Spain                     Adding Spain depending config
    21-04-2021  3.4         JLO          Italy                     Adding Taxregistrationnumber in store partner information
    26-03-2021  3.3         SNAGTZ                                 Included new polish invoice transaction type to types that print 'Address'
    23-03-2021  3.2         SNAGTZ                                 Add additional legislationtype isset checks
    22-12-2020  3.1         JLO          Italy         XV-12581    Return documents registered on a different RT Server
    05-11-2020  3.0         JLO          Italy                     Adding lotteryId as property
    05-10-2020  2.5b        RDH          CTCR20070298              Making this change Bilingual
    18-09-2020  2.5a        RDH          CTCR20070298              print on copy receipt only, not on customer receipt
    18-08-2020  2.4         EOO          CTCR20070298  XV-11965    Add text cash receipt customer order
    18-05-2020  2.3         JLO          Italy                     Configuration new country Italy
    13-03-2020  2.2         RDH          CTAC20030917              personeelkorting substracted twice from rounded and unrounded total.
    06-02-2020  2.1         RDH          CTCR20010845              Making CZ and AT helpers more country specific
    05-02-2020  2.0         RDH          CTCR19120181              Rounding on Cash and reconstruct the country specific configuration
    08-10-2019  1.5         JLO                                    Aanpassing tbv FP3 (Czech / legislation)
    27-08-2019  1.4         JLO                                    Aanpassing tbv FP2 (M4 release)
    07-08-2019  1.3         JLO                                    Aanpassing tbv FP2 (M4 release)
    25-04-2019  1.2         JLO                        XV-8135
    23-11-2018  1.1         JLO          CTCR18050154              KlantGegevens onthouden BTW bon Fase 1
    18-04-2018  1.0         JLO                                    Changing data 5.0 from copy 4.4
    dd-mm-yyyy  0.9         ???                                    Initial version from 4.4         
-->

<trf-dependencies>

    <!-- Directives -->
    <trf-directive id="set_language" parameter="{$language}" />
    <trf-directive id="set_date_locale" parameter="{$date_locale}" />
    <trf-directive id="set_number_locale" parameter="{$number_locale}" />
    <trf-if test="{$channel='mail'}">
        <trf-directive id="set_mail_to" parameter="{$document.getAttribute('mail_info/email')}" />
        <trf-directive id="set_mail_subject" parameter="{posbundlestring($$RECEIPT_BUNDLE_PATH ++ 'MailSubject')}" />
        <trf-directive id="set_mail_body" parameter="{posbundlestring($$RECEIPT_BUNDLE_PATH ++ 'MailBody')}" />
        <trf-directive id="set_mail_attachment_name" parameter="document" />
    </trf-if>

    <!--
        ===============================
        Line Separator and line spacer
        Note: these are invoked to display data in a row / column, thus no table
        definition for these helper templates.
        ===============================
    -->
    <trf-template name="$TEMPLATE_SEPARATOR_LINE">
        <p><b><trf-expression value="{stringrepeat('_',$$WIDTH_PRINTER)}"/></b></p>
    </trf-template>

    <trf-template name="$TEMPLATE_EMPTY_LINE">
        <p/>
    </trf-template>

    <!--
        ====
        Logo
        ====
    -->
        <trf-template name="$TEMPLATE_LOGO">
        <trf-if test="{$$RECEIPT_SHOW_LOGO}">
            <trf-choose>
                <trf-when test="{ifset(existsposbundleimage($$RECEIPT_STORE_LOGO))~false}">
                    <img src="{posbundleimage($$RECEIPT_STORE_LOGO)}"/>
                </trf-when>
                <trf-when test="{ifset(existsposbundleimage($$RECEIPT_DIVISION_LOGO))~false}">
                    <img src="{posbundleimage($$RECEIPT_DIVISION_LOGO)}"/>
                </trf-when>
                <trf-when test="{ifset(existsposbundleimage($$RECEIPT_COMPANY_LOGO))~false}">
                    <img src="{posbundleimage($$RECEIPT_COMPANY_LOGO)}"/>
                </trf-when>
                <trf-otherwise>
                    <img src="{posbundleimage('image.ReceiptLogo')}"/>
                </trf-otherwise>
            </trf-choose>
        </trf-if>
    </trf-template>

    <trf-variable name="$MODE_MASK_DISCOUNT" value="{16}" />
    <trf-variable name="$displayKlachtSign" value="{false}"/>
    <trf-variable name="$totalNonCashPayments" value="{0.0}" /> <!-- CTCR19120181 -->
    <trf-variable name="$RECEIPT_SHORT_LABEL_WIDTH" value="{integer(22)}" />
    <trf-variable name="$RECEIPT_SHORT_VALUE_WIDTH" value="{integer(20)}" />

    <!--
        ====================================
        Receipt document header information
        ====================================
    -->
    <trf-template name="$z_TEMPLATE_RECEIPT_STATE">
        <trf-if test="{$$RECEIPT_SHOW_RECEIPT_STATE}">
            <table>
                <tbody>
                    <!-- Document status if relevant -->
                    <trf-if test="{$$RECEIPT_STATE_SHOW_DOCUMENT_STATUS}">
                        <tr>
                            <td width="{$$WIDTH_PRINTER}" align="{$$RECEIPT_STATE_ALIGN}">
                              <!-- <trf-apply template="$TEMPLATE_EMPTY_LINE"/> -->
                                <trf-variable name="document_status" value=""/>
                                <trf-variable name="temp_status" value=""/>
                                <trf-choose>
                                    <trf-when test="{$document.illegal}">
                                        <trf-variable name="temp_status" value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'transactiontype.' ++ {$document.transactionType} ++ '.DocumentIllegalTitle',$language)}"/>
                                        <trf-if test="{!isset($temp_status)}">
                                            <trf-variable name="temp_status" value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++'DocumentIllegalTitle',$language)}"/>
                                        </trf-if>
                                        <trf-if test="{$bilingual &amp;&amp; {$temp_status != null} &amp;&amp;   {isset(posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'transactiontype.' ++ {$document.transactionType} ++ '.DocumentIllegalTitle',$fallback_language))}}">
                                            <trf-variable name="temp_status" value="{{$temp_status} ++ '/' ++ {ifset(posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'transactiontype.' ++ {$document.transactionType} ++ '.DocumentIllegalTitle',$fallback_language))~ifset(posbundlestring({$$RECEIPT_BUNDLE_PATH} ++'DocumentIllegalTitle',$fallback_language))}}"/>
                                        </trf-if>
                                    </trf-when>
                                    <trf-when test="{$document.status.void}">
                                        <trf-variable name="temp_status" value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'transactiontype.' ++ {$document.transactionType} ++ '.DocumentVoidTitle',$language)}"/>
                                        <trf-if test="{!isset($temp_status)}">
                                            <trf-variable name="temp_status" value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++'DocumentVoidTitle',$language)}"/>
                                        </trf-if>
                                        <trf-if test="{$bilingual &amp;&amp; {$temp_status != null} &amp;&amp; {isset(posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'transactiontype.' ++ {$document.transactionType} ++ '.DocumentVoidTitle',$fallback_language))}}">
                                            <trf-variable name="temp_status" value="{{$temp_status} ++ '/' ++  {ifset(posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'transactiontype.' ++ {$document.transactionType} ++ '.DocumentVoidTitle',$fallback_language))~ifset(posbundlestring({$$RECEIPT_BUNDLE_PATH} ++'DocumentVoidTitle',$fallback_language))}}"/>
                                        </trf-if>
                                    </trf-when>
                                    <trf-when test="{$document.copy}">
                                        <trf-variable name="temp_status" value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'transactiontype.' ++ {$document.transactionType} ++ '.DocumentCopyTitle',$language)}"/>
                                        <trf-if test="{!isset($temp_status)}">
                                            <trf-variable name="temp_status" value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++'DocumentCopyTitle',$language)}"/>
                                        </trf-if>
                                        <trf-if test="{$bilingual &amp;&amp; {$temp_status != null} &amp;&amp; {isset(posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'transactiontype.' ++ {$document.transactionType} ++ '.DocumentCopyTitle',$fallback_language))}}">
                                            <trf-variable name="temp_status" value="{{$temp_status} ++ '/' ++ {ifset(posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'transactiontype.' ++ {$document.transactionType} ++ '.DocumentCopyTitle',$fallback_language))~ifset(posbundlestring({$$RECEIPT_BUNDLE_PATH} ++'DocumentCopyTitle',$fallback_language))}}"/>
                                        </trf-if>
                                    </trf-when>
                                    <trf-when test="{$document.status.waiting}">
                                        <trf-variable name="temp_status" value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'transactiontype.' ++ {$document.transactionType} ++ '.DocumentInWaitTitle',$language)}"/>
                                        <trf-if test="{!isset($temp_status)}">
                                            <trf-variable name="temp_status" value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++'DocumentInWaitTitle',$language)}"/>
                                        </trf-if>
                                        <trf-if test="{$bilingual &amp;&amp; {$temp_status != null} &amp;&amp; {isset(posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'transactiontype.' ++ {$document.transactionType} ++ '.DocumentInWaitTitle',$fallback_language))}}">
                                            <trf-variable name="temp_status" value="{{$temp_status} ++ '/' ++ {ifset(posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'transactiontype.' ++ {$document.transactionType} ++ '.DocumentInWaitTitle',$fallback_language))~ifset(posbundlestring({$$RECEIPT_BUNDLE_PATH} ++'DocumentInWaitTitle',$fallback_language))}}"/>
                                        </trf-if>
                                    </trf-when>
                                </trf-choose>
                                <trf-variable name="document_status" value="{$document_status~''++' '}{$temp_status}"/>
                                <!--
                                <trf-if test="{isset($document_status)}">
                                    <p style="font-stretch:wide high;"><b><trf-expression value="{$document_status}"/></b></p>
                                </trf-if>
                                -->
                            </td>
                        </tr>
                    </trf-if>
                    <!-- Document title -->
                    <trf-if test="{$$RECEIPT_STATE_SHOW_DOCUMENT_TITLE &amp;&amp; !($document.status.void)}">
                        <trf-variable name="document_title" value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'transactiontype.' ++ {$document.transactionType} ++ '.DocumentTitle',$language)}"/>
                        <trf-if test="{!isset($document_title)}">
                            <trf-variable name="document_title" value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++'DocumentTitle',$language)}"/>
                        </trf-if>
                        <trf-if test="{{$bilingual} &amp;&amp; !{$document_title = null} &amp;&amp; {isset(posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'transactiontype.' ++ {$document.transactionType} ++ '.DocumentTitle',$fallback_language))}}">
                            <trf-variable name="document_title" value="{{$document_title} ++ '/' ++ {ifset(posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'transactiontype.' ++ {$document.transactionType} ++ '.DocumentTitle',$fallback_language))~(posbundlestring({$$RECEIPT_BUNDLE_PATH} ++'DocumentTitle',$fallback_language))}}"/>
                        </trf-if>
                        <!--
                        <trf-if test="{isset($document.revisionType) &amp;&amp; ($document.revisionType!='initial')}">
                            <trf-variable name="document_title" value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'transactiontype.' ++ {$document.transactionType} ++ '.DocumentRevisedTitle',$language)}"/>
                            <trf-if test="{!isset($document_title)}">
                                <trf-variable name="document_title" value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++'DocumentRevisedTitle',$language)}"/>
                            </trf-if>
                            <trf-if test="{{$bilingual} &amp;&amp; {$document_title != null} &amp;&amp; { isset(posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'transactiontype.' ++ {$document.transactionType} ++ '.DocumentRevisedTitle',$fallback_language))}}">
                                <trf-variable name="document_title" value="{{$document_title} ++ '/' ++ {ifset(posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'transactiontype.' ++ {$document.transactionType} ++ '.DocumentRevisedTitle',$fallback_language))~(posbundlestring({$$RECEIPT_BUNDLE_PATH} ++'DocumentRevisedTitle',$fallback_language))}}"/>
                            </trf-if>
                        </trf-if>
                        -->
                         <trf-if test="{isset($document.displayProperties)}">
                            <trf-foreach name="prop" list="{$document.displayProperties}">
                                <trf-variable name="propertyValue" value="{$document.displayProperties.{$prop}.second}"/>
                                <trf-if test="{!isset($propertyValue) &amp;&amp; {$prop = 'attribute(z_btw)'}}">
                                    <trf-variable name="document_title" value=""/>
                                </trf-if>
                            </trf-foreach>
                        </trf-if>
                    </trf-if>
                    <!-- Document revision -->
                    <trf-if test="{$$RECEIPT_STATE_SHOW_DOCUMENT_TITLE &amp;&amp; !($document.status.void)}">
                        <trf-variable name="DocumentRevisedTitle" value=""/>
                        <trf-if test="{isset($document.revisionType) &amp;&amp; ($document.revisionType!='initial')}">
                            <trf-variable name="DocumentRevisedTitle" value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'transactiontype.' ++ {$document.transactionType} ++ '.DocumentRevisedTitle',$language)}"/>
                            <trf-if test="{!isset($DocumentRevisedTitle)}">
                                <trf-variable name="DocumentRevisedTitle" value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++'DocumentRevisedTitle',$language)}"/>
                            </trf-if>
                            <trf-if test="{{$bilingual} &amp;&amp; {$DocumentRevisedTitle != null} &amp;&amp; { isset(posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'transactiontype.' ++ {$document.transactionType} ++ '.DocumentRevisedTitle',$fallback_language))}}">
                                <trf-variable name="DocumentRevisedTitle" value="{{$DocumentRevisedTitle} ++ '/' ++ {ifset(posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'transactiontype.' ++ {$document.transactionType} ++ '.DocumentRevisedTitle',$fallback_language))~(posbundlestring({$$RECEIPT_BUNDLE_PATH} ++'DocumentRevisedTitle',$fallback_language))}}"/>
                            </trf-if>
                        </trf-if>
                    </trf-if>

                    <tr>
                        <td width="{$$WIDTH_PRINTER}" align="{$$RECEIPT_STATE_ALIGN}">
                            <trf-if test="{isset($document_title) &amp;&amp; !(isset($document_status))}">
                                <p style="font-stretch:normal high;"><trf-expression value="{$document_title}"/></p>
                            </trf-if>
                            <trf-if test="{isset($document_status) &amp;&amp; !(isset($document_title)) &amp;&amp; !(isset($DocumentRevisedTitle))}">
                                <p style="font-stretch:normal high;"><trf-expression value="{$document_status}"/></p>
                            </trf-if>
                            <trf-if test="{isset($document_status) &amp;&amp; !isset($document_title) &amp;&amp; isset($DocumentRevisedTitle)}">
                                <p style="font-stretch:normal high;"><trf-expression value="{$document_status} "/><trf-expression value="{$DocumentRevisedTitle}"/></p>
                            </trf-if>
                            <trf-if test="{isset($document_status) &amp;&amp; isset($document_title) &amp;&amp; isset($DocumentRevisedTitle)}">
                                <p style="font-stretch:normal high;"><trf-expression value="{$document_status} "/><trf-expression value="{$document_title} "/><trf-expression value="{$DocumentRevisedTitle}"/></p>
                            </trf-if>
                            <trf-if test="{isset($document_status) &amp;&amp; isset($document_title) &amp;&amp; !(isset($DocumentRevisedTitle))}">
                                <p style="font-stretch:normal high;"><trf-expression value="{$document_status} "/><trf-expression value="{$document_title}"/></p>
                            </trf-if>
                        </td>
                    </tr>
                    <!-- Document type and Transaction type -->
                    <trf-if test="{$$RECEIPT_STATE_SHOW_TRANSACTION_TYPE}">
                        <tr>
                            <td width="{$$WIDTH_PRINTER}" align="{$$RECEIPT_STATE_ALIGN}">
                                <trf-apply template="$TEMPLATE_EMPTY_LINE"/>
                                <trf-variable name="transaction_type" value="{valueinfo('TransactionTypes',$document.transactionType~null)~null.title}"/>
                                <trf-if test="{isset($transaction_type)}">
                                    <p style="font-stretch-horizonal:wide;"><b><trf-expression value="{uppercase($transaction_type)}"/></b></p>
                                </trf-if>
                            </td>
                        </tr>
                    </trf-if>
                </tbody>
            </table>
        </trf-if>
    </trf-template>


    <trf-template name="$z_TEMPLATE_RECEIPT_ADD_INFO_DOC">
        <trf-if test="{$$RECEIPT_SHOW_RECEIPT_STATE}">
            <table width="{$$WIDTH_PRINTER}">
                <tbody>
                    <!-- Document completion timestamp -->
                    <trf-if test="{($$RECEIPT_STATE_SHOW_DOCUMENT_COMPLETIONTIMESTAMP) &amp;&amp; ($document.completionTimestamp!=null)}">
                        <tr>
                            <td width="{{$$WIDTH_PRINTER}/2}" align="{$$RECEIPT_STATE_ALIGN_DATE}">
                                <trf-variable name="date" value="{ifset($document.completionTimestamp)}"/>
                                <trf-if test="{isset($date)}">
                                    <trf-if test="{!($$RECEIPT_ARTICLES_SHOW_DESCRIPTION_COLUMN)}">
                                        <p><trf-expression value="{formatdate($document.completionTimestamp,$datetime_format)}"/></p>
                                    </trf-if>
                                    <trf-if test="{$$RECEIPT_ARTICLES_SHOW_DESCRIPTION_COLUMN}">
                                        <p><trf-expression value="{$$WIDTH_PRINTER}{ifset(posbundlestring({$$RECEIPT_BUNDLE_PATH} ++'DocumentDate',$language))~''++': '}{formatdate($document.completionTimestamp,$datetime_format)}"/></p>
                                    </trf-if>
                                </trf-if>
                            </td>
                            <td width="{{$$WIDTH_PRINTER}/2}" align="{$$RECEIPT_STATE_ALIGN_DOC_INFO}">
                                <trf-variable name="device_code" value="{$document.attributes.device_code}"/>
                                <trf-if test="{isset($document.documentId) &amp;&amp; {$document.getPartner('sold_by').country != 'ES' }}">
                                    <trf-variable name="device_code" value="{{$device_code} ++ '-' ++ {$document.documentId}}"/>
                                <p><trf-expression value="{$device_code}"/></p>
                                </trf-if>
                            </td>
                        </tr>
                    </trf-if>
                    <trf-if test="{isset($document.documentId) &amp;&amp; {$document.getPartner('sold_by').country = 'ES'}}">
                                                                      
                        <tr>
                            <td width="{{$$WIDTH_PRINTER}}" >
                                <trf-variable name="device_code" value="{$document.attributes.device_code}"/>
                                <trf-if test="{isset($document.documentId) &amp;&amp; {$document.getPartner('sold_by').country = 'ES'}}">
                                    <trf-variable name="device_code" value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++'DocumentId',$language)}: {{$device_code} ++ '-' ++ {$document.documentId}}"/>
                                <p><trf-expression value="{$device_code}"/></p>
                                </trf-if>
                            </td>
                        </tr>
                    </trf-if>
                <!--
                    ====
                    Original document id
                    ====
                -->
                <trf-if test="{$document.getPartner('sold_by').country = 'ES'}">
                    <trf-foreach name="id" list="{$document.getAttachmentIds()}">
                        <trf-variable name="attachment" value="{$document.getAttachment($id)}" />
                        <trf-if test="{$attachment.mimeType='application/x-xv-business-zip'}">
                            <trf-variable name="objects" value="{ifset(xvburead(unzip($attachment.data)))}" />
                            <trf-foreach name="object" list="{$objects}">
                                <trf-if test="{isinstanceof($object,class('Document'))}">
                                    <tr>
                                        <td width="{{$$WIDTH_PRINTER}}" >
                                            <trf-variable name="imported_document" value="{{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++'DocumentReference',$language)} ++ ': ' ++{$object.documentId}}" />
                                            <p><trf-expression value="{$imported_document}"/></p>
                                        </td>
                                    </tr>
                                </trf-if>
                            </trf-foreach>
                        </trf-if>
                    </trf-foreach>
                </trf-if>
                    <!-- Document uid -->
                    <trf-if test="{$$RECEIPT_STATE_SHOW_DOCUMENT_UID}">
                        <tr>
                            <td colspan="2" width="{$$WIDTH_PRINTER}" align="{$$RECEIPT_STATE_ALIGN}">
                                <p><trf-expression value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++'DocumentUid', $language)}: {$document.documentUid}"/></p>
                            </td>
                        </tr>
                    </trf-if>
                    <!-- Security seal -->
                    <!--
                    <trf-if test="{$$RECEIPT_STATE_SHOW_SECURITY_SEAL}">
                        <tr> 
                            <td colspan="2" width="{$$WIDTH_PRINTER}" align="{$$RECEIPT_STATE_ALIGN}">                                                              
                                <p><trf-expression value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++'SecuritySeal',$language)}: {$document.securitySeal}"/></p>
                            </td>
                        </tr>
                    </trf-if>
                    -->
                    <!-- Document type -->
                    <trf-if test="{$$RECEIPT_STATE_SHOW_DOCUMENT_TYPE &amp;&amp; (isset($document.documentTypeId) || {ifset($$RECEIPT_STATE_SHOW_DOCUMENT_TYPE_ALWAYS)~false})}">
                        <tr>
                            <td colspan="2" width="{$$WIDTH_PRINTER}" align="left">
                                <trf-variable name="document_type_id_label" value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++'DocumentTypeId',$language)}: "/>
                                <trf-if test="{ifset(contains($$RECEIPT_STATE_HIDE_DOCUMENT_TYPE_LABEL,$document.documentType))~false}">
                                    <trf-variable name="document_type_id_label" value=""/>
                                </trf-if>
                                <p><b><trf-expression value="{$document_type_id_label}{$document.documentTypeId}"/></b></p>
                            </td>
                        </tr>
                    </trf-if>
                    <!-- Backend uid -->
                    <!--
                    <trf-if test="{$$RECEIPT_STATE_SHOW_BACKEND_UID}">
                        <tr>
                            <td colspan="2" width="{$$WIDTH_PRINTER}" align="{$$RECEIPT_STATE_ALIGN_DATE}}">
                                <trf-variable name="uid" value="{ifset($document.externalReference.backendDocumentUid)}"/>
                                <trf-if test="{isset($uid) &amp;&amp; {{$uid} != {$document.documentUid}}">
                                    <p><trf-expression value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++'ExternalId',$language)}: {$uid}"/></p>
                                </trf-if>
                            </td>
                        </tr>
                    </trf-if>
                    -->
                    <!-- Document reference -->
                    <trf-if test="{$$RECEIPT_STATE_SHOW_DOCUMENT_REFERENCE}">
                        <tr>
                            <td colspan="2" width="{$$WIDTH_PRINTER}" align="{$$RECEIPT_STATE_ALIGN}">
                                <trf-if test="{isset($document.reference)}">
                                    <p><trf-expression value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++'DocumentReference',$language)}: {$document.reference}"/></p>
                                </trf-if>
                            </td>
                            <td colspan="2" width="{$$WIDTH_PRINTER}" align="{$$RECEIPT_STATE_ALIGN}">
                                <trf-if test="{isset($document.attributes.backend_order_number)}">
                                    <p><trf-expression value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++'DocumentReference',$language)}: {document.attributes.backend_order_number}"/></p>
                                </trf-if>
                            </td>
                        </tr>
                    </trf-if>
                    <!-- Delivery date -->
                    <trf-if test="{$$RECEIPT_STATE_SHOW_DELIVERY_DATE}">
                        <tr>
                            <td colspan="2" width="{$$WIDTH_PRINTER}" align="{$$RECEIPT_STATE_ALIGN}">
                                <trf-variable name="process_info" value="{ifset(processbydocument($document))}"/>
                                <trf-variable name="supports_due_groups" value="{ifset(entryinfo($process_info,'due_groups_allowed').booleanValue)~false}"/>
                                <trf-variable name="date" value="{ifset($document.dueGroups[0].confirmedDueDate)}"/>
                                <trf-if test="{$supports_due_groups &amp;&amp; isset($date)}">
                                    <p><trf-expression value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++'DeliveryDate')}: {formatdate($date,$receipt_date_format)}"/></p>
                                </trf-if>
                            </td>
                        </tr>
                    </trf-if>
                </tbody>
            </table>
        </trf-if>
    </trf-template>

    <!--
        ==================================
        Receipt store partner information
        ==================================
    -->
    <trf-template name="$z_TEMPLATE_RECEIPT_STORE_PARTNER">
        <trf-if test="{$$RECEIPT_SHOW_STORE_PARTNER}">
            <table>
                <tbody>
                    <trf-variable name="partner" value="{$document.getPartner('sold_by')}"/>
                    <trf-if test="{isset($partner.name)}">
                        <tr>
                            <td width="{$$WIDTH_PRINTER}" align="{$$RECEIPT_STORE_PARTNER_ALIGN}">
                                <trf-if test="{isset(posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'transactiontype.' ++ {$groupCode} ++ '.Hqaddress',$language))}">
                                    <p><trf-expression value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'transactiontype.' ++ {$groupCode} ++ '.Hqaddress',$language)}"/></p>
                                </trf-if>
                                <p><trf-expression value="{$partner.partnerId} {$partner.name}"/></p>
                                <trf-choose>
                                    <trf-when test="{isset($partner.street)}">
                                        <p><trf-expression value="{$partner.street} {$partner.houseNumber}"/></p>
                                    </trf-when>
                                    <trf-otherwise>
                                        <p><trf-expression value="{$partner.address}"/></p>
                                    </trf-otherwise>
                                </trf-choose>
                                <trf-variable name="groupCode" value="{substring($document.attributes.location_code,0,1) ++ '000'}"/>
                                <trf-if test="{isset(posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'transactiontype.' ++ {$groupCode} ++ '.Taxregistrationnumber',$language))}">
                                    <p><trf-expression value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'transactiontype.' ++ {$groupCode} ++ '.Taxregistrationnumber',$language)}"/></p>
                                </trf-if>
                             <!--<p><trf-expression value="{$partner.postalCode} {$partner.city}"/></p> -->
                            </td>
                        </tr>
                        <!--
                        <tr>
                            <td width="{$$WIDTH_PRINTER}" align="{$$RECEIPT_STORE_PARTNER_ALIGN}">
                                <trf-apply template="$TEMPLATE_SEPARATOR_LINE"/>
                                <trf-apply template="$TEMPLATE_EMPTY_LINE"/>
                            </td>
                        </tr>
                        -->
                    </trf-if>
                </tbody>
            </table>
        </trf-if>
    </trf-template>



   <!--
        ============================================
        Receipt document comments and data captures
        ============================================
    -->
    <trf-template name="$z_TEMPLATE_RECEIPT_DOCUMENT_COMMENTS">
        <trf-if test="{$$RECEIPT_SHOW_DOCUMENT_COMMENTS}">
            <trf-variable name="print_separator_line" value="{false}"/>
            <table>
                <tbody>
                    <!-- Document captures -->
                    <trf-if test="{$$RECEIPT_DOCUMENT_CAPTURES_SHOW}">
                        <tr>
                            <td width="{$$WIDTH_PRINTER}" align="{$$RECEIPT_DOCUMENT_COMMENTS_ALIGN}">
                                <trf-foreach name="prop" list="{$document.displayProperties}">
                                    <p><trf-expression value="{{$document.displayProperties.{$prop}.first} ++ ': ' ++ {$document.displayProperties.{$prop}.second}}"/></p>
                                    <trf-variable name="print_separator_line" value="{false}"/>
                                </trf-foreach>
                            </td>
                        </tr>
                    </trf-if>
                    <!-- Document comments -->
                    <trf-if test="{$$RECEIPT_DOCUMENT_COMMENTS_SHOW}">
                        <tr>
                            <td width="{$$WIDTH_PRINTER}" align="{$$RECEIPT_DOCUMENT_COMMENTS_ALIGN}">
                                <trf-foreach name="prop" list="{$document.comments}">
                                    <trf-if test="{!isset($$RECEIPT_DOCUMENT_COMMENTS) || contains($$RECEIPT_DOCUMENT_COMMENTS,$prop)}">
                                        <trf-variable name="comment" value="{$document.comments.($prop)}"/>
                                        <trf-if test="{$$RECEIPT_DOCUMENT_COMMENTS_SHOW_TITLES}">
                                            <trf-variable name="comment" value="{valueinfo('CommentTypes',$prop~'')~$prop.title}: {$comment}"/>
                                        </trf-if>
                                        <p><trf-expression value="{$comment}"/></p>
                                        <trf-variable name="print_separator_line" value="{false}"/>
                                    </trf-if>
                                </trf-foreach>
                            </td>
                        </tr>
                    </trf-if>
                    <trf-if test="{$print_separator_line}">
                        <tr>
                            <td width="{$$WIDTH_PRINTER}" align="{$$RECEIPT_DOCUMENT_COMMENTS_ALIGN}">
                                <trf-if test="{$$RECEIPT_DOCUMENT_COMMENTS_SHOW_SEPARATOR_LINE}">
                                    <trf-apply template="$TEMPLATE_SEPARATOR_LINE"/>
                                </trf-if>
                                <!--
                                <trf-apply template="$TEMPLATE_EMPTY_LINE"/>
                                -->
                            </td>
                        </tr>
                    </trf-if>
                </tbody>
            </table>
        </trf-if>
    </trf-template>

    <!--
        =====================
        Receipt store header
        =====================
    -->
    <trf-template name="$TEMPLATE_RECEIPT_STORE_HEADER">
        <trf-if test="{$$RECEIPT_SHOW_STORE_HEADER}">
            <table>
                <tbody>
                    <tr>
                        <td width="{$$WIDTH_PRINTER}" align="{$$RECEIPT_STORE_HEADER_ALIGN}">       
                            <trf-if test="{isset($print_header)}">
                            <!-- <trf-apply template="$TEMPLATE_EMPTY_LINE"/> -->
                                <p><trf-expression value="{$print_header}"/></p>
                            </trf-if>
                        </td>
                    </tr>
                    <tr>
                        <td width="{$$WIDTH_PRINTER}" align="{$$RECEIPT_STORE_HEADER_ALIGN}">
                            <trf-if test="{$$RECEIPT_SHOW_STORE_HEADER_SEPARATOR_LINE}">
                             <!-- <trf-apply template="$TEMPLATE_EMPTY_LINE"/> -->
                                <trf-apply template="$TEMPLATE_SEPARATOR_LINE"/>
                            </trf-if>
                            <!--
                            <trf-apply template="$TEMPLATE_EMPTY_LINE"/>
                            -->
                        </td>
                    </tr>
                </tbody>
            </table>
        </trf-if>
    </trf-template>

    <!--
        ====================================
        Receipt POS user header information
        ====================================
    -->
    <trf-template name="$z_TEMPLATE_RECEIPT_USER_HEADER">
                                                                                               
        <trf-if test="{$$RECEIPT_SHOW_USER_HEADER &amp;&amp; ($user != null)}">
            <table>
                <tbody>
                    <tr>
                        <td width="{$$WIDTH_PRINTER}" align="{$$RECEIPT_USER_HEADER_ALIGN}">
                            <trf-variable name="user_length" value="{length($user) - 3}"/>
                            <trf-variable name="cashier" value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++'cashier',$language)}"/>
                            <trf-choose>
                                <trf-when test="{isset($cashier)}">
                                    <p><b><trf-expression value="{$cashier} {$user}"/></b></p>
                                </trf-when>
                                <trf-otherwise>
                                    <trf-variable name="partnerName" value="{ifset(split($document.getPartner('closed_by').name,' ')[0])}"/>                                                                                
                                    <trf-choose>
                                        <trf-when test="{isset($partnerName)}">
                                            <p><trf-expression value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++'ServedBy',$language)}: {$partnerName}"/></p>
                                        </trf-when>
                                        <trf-otherwise>
                                            <p><trf-expression value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++'ServedBy',$language)}: {$user}"/></p>
                                        </trf-otherwise>
                                    </trf-choose>
                                </trf-otherwise>
                           </trf-choose>
                        </td>
                    </tr>
                </tbody>
            </table>
        </trf-if>
    </trf-template>

    <!--
    ===============================================================
    Receipt additional partners information - e.g. sold-to partner
    ===============================================================
    -->
    <trf-template name="$z_TEMPLATE_RECEIPT_ADDITIONAL_PARTNERS">
        <trf-if test="{$$RECEIPT_SHOW_ADDITIONAL_PARTNERS}">
            <table>
                <tbody>
                    <tr>
                        <td width="{$$WIDTH_PRINTER}" align="{$$RECEIPT_ADDITIONAL_PARTNERS_ALIGN}">
                            <trf-variable name="partner" value="{$document.getPartner('sold_to')}"/>
                            <trf-if test="{isset($partner.name)}">
                                <p><trf-expression value="{$partner.name} {$partner.nameAdditional} {$partner.name3} {$partner.name4}"/></p>
                            </trf-if>
                            <trf-if test="{{$document.transactionType != 'zcl2011'} &amp;&amp; {$document.transactionType != 'zcl2012'} &amp;&amp; {$document.transactionType != 'z_cl0131_it'} &amp;&amp; {$document.transactionType != 'z_cl0132_it'}}">
                                <!--
                                <trf-apply template="$TEMPLATE_EMPTY_LINE"/>
                                -->
                                <!--
                                <trf-if test="{isset(posbundlestring({$$RECEIPT_BUNDLE_PATH} ++'SoldToPartnerLabel',$language))}">
                                    <p><b><trf-expression value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++'SoldToPartnerLabel',$language)}"/></b></p>
                                </trf-if>
                                -->
                                <trf-choose>
                                    <trf-when test="{isset($partner.street)}">
                                        <p><trf-expression value="{$partner.street} {$partner.houseNumber}"/></p>
                                    </trf-when>
                                    <trf-otherwise>
                                        <trf-if test="{isset($partner.address)}" >
                                            <p><trf-expression value="{$partner.address}"/></p>
                                        </trf-if>
                                    </trf-otherwise>
                                </trf-choose>
                                <trf-if test="{isset($partner.postalCode) || isset($partner.city) }" >
                                    <p><trf-expression value="{$partner.postalCode} {$partner.city}"/></p>
                                </trf-if>
                                <trf-if test="{isset($partner.phone)}" >
                                    <p><trf-expression value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++'Phone',$language)}"/> <trf-expression value="{$partner.phone}"/></p>
                                </trf-if>
                                <!-- <trf-if test="{isset($partner.email)}" >
                                    <p><trf-expression value="{$partner.email}"/></p>
                                </trf-if>
                                -->
                                <trf-if test="{isset($partner.taxRegistrationNumber)}">
                                    <p><b><trf-expression value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++'VatNr',$language)}"/></b> <trf-expression value="{$partner.taxRegistrationNumber}"/></p>
                                </trf-if>
                                <trf-if test="{isset($partner.phone2)}">
                                    <p><b><trf-expression value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++'VatNr',$language)}"/></b> <trf-expression value="{$partner.phone2}"/></p>
                                </trf-if>
                                <trf-if test="{isset($partner.fax)}">
                                    <p><b><trf-expression value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++'SdiCode',$language)}"/></b> <trf-expression value="{$partner.fax}"/></p>
                                </trf-if>
                                <trf-if test="{isset($partner.email)}">
                                    <p><b><trf-expression value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++'PecEmail',$language)}"/></b> <trf-expression value="{$partner.email}"/></p>
                                </trf-if>
                            </trf-if>
                            <trf-if test="{isset($partner.name) &amp;&amp; isset($document.displayProperties)}">
                                <trf-foreach name="prop" list="{$document.displayProperties}">
                                    <trf-variable name="propertyValue" value="{$document.displayProperties.{$prop}.second}"/>
                                    <trf-if test="{isset($propertyValue)}">
                                        <trf-choose>
                                            <trf-when test="{$prop = 'attribute(z_btw)'}">
                                                <p><b><trf-expression value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++'VatNr',$language)}" /></b> <trf-expression value="{$document.displayProperties.{$prop}.second}"/></p>
                                            </trf-when>
                                            <trf-otherwise>
                                                <p><trf-expression value="{{$document.displayProperties.{$prop}.first} ++ ': ' ++ {$document.displayProperties.{$prop}.second}}"/></p>
                                            </trf-otherwise>
                                        </trf-choose>
                                    </trf-if>
                                </trf-foreach>
                            </trf-if>
                            <!-- <trf-if test="{!isset($partner.name) &amp;&amp; {$document.getPartner('sold_by').country = 'ES'}}">
                                <trf-if test="{isset($partner.phone2)}">
                                    <p><b><trf-expression value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++'VatNr',$language)}"/></b> <trf-expression value="{$partner.phone2}"/></p>
                                </trf-if>
                            </trf-if> -->
                            <trf-variable name="partner" value="{$document.getPartner('ship_to')}"/>
                            <trf-if test="{isset($partner.name)}">
                                <!--
                                <trf-apply template="$TEMPLATE_EMPTY_LINE"/>
                                -->
                                <trf-if test="{isset(posbundlestring({$$RECEIPT_BUNDLE_PATH} ++'ShipToPartner',$language))}">
                                    <p><b><trf-expression value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++'ShipToPartner',$language)}"/></b></p>
                                </trf-if>
                                <p><trf-expression value="{$partner.name}"/></p>
                                <trf-choose>
                                    <trf-when test="{isset($partner.street)}">
                                        <p><trf-expression value="{$partner.street} {$partner.houseNumber}"/></p>
                                    </trf-when>
                                    <trf-otherwise>
                                        <p><trf-expression value="{$partner.address}"/></p>
                                    </trf-otherwise>
                                </trf-choose>
                                <p><trf-expression value="{$partner.postalCode} {$partner.city}"/></p>
                            </trf-if>
                            <trf-variable name="partner" value="{$document.getPartner('bill_to')}"/>
                            <trf-if test="{isset($partner.name)}">
                                <!--
                                <trf-apply template="$TEMPLATE_EMPTY_LINE"/>
                                -->
                                <trf-if test="{isset(posbundlestring({$$RECEIPT_BUNDLE_PATH} ++'BillToPartner',$language))}">
                                    <p><b><trf-expression value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++'BillToPartner',$language)}"/></b></p>
                                </trf-if>
                                <p><trf-expression value="{$partner.name}"/></p>
                                <trf-choose>
                                    <trf-when test="{isset($partner.street)}">
                                        <p><trf-expression value="{$partner.street} {$partner.houseNumber}"/></p>
                                    </trf-when>
                                    <trf-otherwise>
                                        <p><trf-expression value="{$partner.address}"/></p>
                                    </trf-otherwise>
                                </trf-choose>
                                <p><trf-expression value="{$partner.postalCode} {$partner.city}"/></p>
                            </trf-if>
                            <trf-if test="{$$RECEIPT_STATE_SHOW_BACKEND_UID}">
                                <trf-variable name="uid" value="{ifset($document.getAttribute('backend_order_number')) ~ ifset($document.externalReference.backendDocumentUid)}"/>
                                <trf-if test="{isset($uid) &amp;&amp; {{$uid} != {$document.documentUid}}}">
                                    <p><trf-expression value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++'ExternalId',$language)}: {$uid}"/></p>
                                </trf-if>
                            </trf-if>
                        </td>
                    </tr>
                </tbody>
            </table>
        </trf-if>
    </trf-template>

    <!--
        =========
        Articles
        =========
    -->
    <trf-template name="$z_TEMPLATE_RECEIPT_ARTICLES">
        <trf-if test="{$$RECEIPT_SHOW_ARTICLES_NEW}">
            <!-- Spacer row -->
            <trf-apply template="$TEMPLATE_EMPTY_LINE"/>
            <p><b><trf-expression value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++'ArticleBlockLabel',$language)}"/></b></p>

            <trf-variable name="width_description" value="{$$WIDTH_PRINTER - $$RECEIPT_QUANTITY_WIDTH - ($$RECEIPT_ARTICLES_SHOW_DESCRIPTION_COLUMN?$$RECEIPT_ARTICLE_WIDTH:0) - ($$RECEIPT_ARTICLES_SHOW_UNIT_COLUMN?$$RECEIPT_UNIT_WIDTH:0) - (2*$$RECEIPT_AMOUNT_WIDTH)}" />
            <table width="{$$WIDTH_PRINTER}">
                <tbody>
                    <!-- Line column headers -->
                    <tr>
                        <!-- Default column headers-->
                        <td align="left">
                            <p><b><trf-expression value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'QuantityLabel',$language)}"/></b></p>
                        </td>
                        <!-- Print the unit and the description in separate columns when not printing the default receipt -->
                        <trf-if test="{$$RECEIPT_ARTICLES_SHOW_UNIT_COLUMN}">
                            <td align="left">
                                <p><b><trf-expression value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'UnitLabel',$language)}"/></b></p>
                            </td>
                        </trf-if>
                        <td align="left">
                            <p><b><trf-expression value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'CodeLabel',$language)}"/></b></p>
                        </td>
                        <trf-if test="{$$RECEIPT_ARTICLES_SHOW_DESCRIPTION_COLUMN}">
                            <td align="left" width="{$width_description}">
                                <p><b><trf-expression value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'DescriptionLabel',$language)}"/></b></p>
                            </td>
                        </trf-if>
                        <trf-choose>
                            <trf-when test="{!($document.pricingDisabled)}">
                                <td align="right">
                                    <p><b><trf-expression value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'UnitPriceLabel',$language)}"/></b></p>
                                </td>
                                <td align="right">
                                    <p><b><trf-expression value="{$document.currency}"/></b></p>
                                </td>
                            </trf-when>
                            <trf-otherwise>
                                <td colspan="2"/>
                            </trf-otherwise>
                        </trf-choose>
                    </tr>
                    <!-- Determine the line groups -->
                    <trf-variable name="lines" value="{$document.normalLines}" />
                    <trf-variable name="showVoidedLines" value="{(count($document.voidedLines) &gt; 0) &amp;&amp; (ifset($$RECEIPT_ARTICLES_SHOW_VOIDED_LINES)~false)}" />
                    <trf-variable name="lines" value="{$showVoidedLines ? ($lines ++! ($document.voidedLines)) : $lines}" />
                    <trf-variable name="lineGroup" value="{$lines}"/>
                    <trf-variable name="lineGroups" value="{list()}"/>
                    <trf-if test="{$document.documentType='direct_sales' || $document.documentType='z_invoice' || $document.documentType='z_b2c'}">
                        <trf-variable name="lineGroup" value="{list()}"/>
                        <trf-variable name="lineGroupId" value="{null}"/>
                        <trf-foreach name="line" list="{$lines}">
                            <trf-choose>
                                <trf-when test="{$lineGroupId=($line.dueGroupId)}">
                                    <trf-variable name="lineGroup" value="{($lineGroup) ++ !list($line)}"/>
                                </trf-when>
                                <trf-otherwise>
                                    <trf-if test="{count($lineGroup)&gt;0}">
                                        <trf-variable name="lineGroups" value="{($lineGroups) ++ !list($lineGroup)}" />
                                    </trf-if>
                                    <trf-variable name="lineGroup" value="{list($line)}" />
                                </trf-otherwise>
                            </trf-choose>
                            <trf-variable name="lineGroupId" value="{$line.dueGroupId}"/>
                            <trf-if test="{isset($line.reason.code)}">
                                <trf-if test="{($line.reason.code = 'z_klacht') || ($line.reason.code = 'z_wrong_buy') || ($line.reason.code = 'z_cancellation')}">
                                    <trf-variable name="$displayKlachtSign" value="{true}"/>
                                </trf-if>
                            </trf-if>
                            <trf-if test="{isset($line.priceReason.code)}">
                                <trf-if test="{($line.priceReason.code = 'z_promotion_discount') || ($line.priceReason.code = 'z_damage_discount')}">
                                    <trf-variable name="$displayKlachtSign" value="{true}"/>
                                </trf-if>
                            </trf-if>
                        </trf-foreach>
                    </trf-if>
                    <trf-if test="{count($lineGroup)&gt;0}">
                        <trf-variable name="lineGroups" value="{($lineGroups) ++ !list($lineGroup)}"/>
                    </trf-if>
                    <!-- Process each line and print the desired information-->
                    <trf-variable name="tot_comp" value="{list()}"/>
                    <trf-variable name="docGroupCount" value="{count($document.lineGroups)}"/>
                    <trf-foreach name="lineGroup" list="{$lineGroups}">
                        <trf-if test="{(count($lineGroup)&gt;0)&amp;&amp;($docGroupCount&gt;0)}">
                            <trf-if test="{isset($document.getLineGroup($lineGroup[0].lineGroupId))}">
                                <tr>
                                    <td colspan="4">
                                        <p><b><trf-expression value="{$document.getLineGroup($lineGroup[0].lineGroupId).getTitle()}" /></b></p>
                                    </td>
                                </tr>
                            </trf-if>
                            <trf-if test="{!isset($document.getLineGroup($lineGroup[0].lineGroupId))}">
                                <tr>
                                    <td colspan="4">
                                        <p><b><trf-expression value="{posbundlestring('title.NoLineGroupAssigned')}" /></b></p>
                                    </td>
                                </tr>
                            </trf-if>
                        </trf-if>
                        <trf-variable name="subtotal" value="{0}"/>
                        <trf-foreach name="line" list="{$lineGroup}">
                            <trf-if test="{isset($line.articleCode) &amp;&amp; ($line.totalQuantity!=0)}">
                                <trf-variable name="column_desc_indent" value="{0}"/>
                                <trf-variable name="ancestor" value="{$line}"/>
                                <trf-while test="{isset($ancestor)}">
                                    <trf-if test="{iscomponent($ancestor)}">
                                        <trf-variable name="column_desc_indent" value="{$column_desc_indent+2}"/>
                                    </trf-if>
                                    <trf-variable name="ancestor" value="{getline($document, $ancestor.parentLineId)}"/>
                                </trf-while>
                                <trf-variable name="isVoided" value="{$line.status.status = 'void'}" />
                                <trf-variable name="showNoDiscountMarker" value="{isset($$RECEIPT_ARTICLES_NO_DISCOUNT_ALLOWED_MARKER) &amp;&amp; (!($line.discountAllowed))}" />
                                <tr>
                                    <td width="{$$RECEIPT_QUANTITY_WIDTH}" align="left">
                                        <p><trf-expression value="{formatnumber($line.totalQuantity,$quantity_format)}"/></p>
                                        <trf-if test="{($line.isCountable()) &amp;&amp; ($line.totalQuantity &gt; 0) &amp;&amp; !($isVoided)}">
                                            <trf-variable name="tot_comp" value="{$tot_comp +! map('unit',$line.unit,'quantity',$line.totalQuantity)}"/>
                                            <trf-variable name="tot_comp" value="{sort($tot_comp,comparator('unit'))}"/>
                                        </trf-if>
                                    </td>
                                    <!-- Print the unit and the description in separate columns when not printing the default receipt -->
                                    <trf-if test="{$$RECEIPT_ARTICLES_SHOW_UNIT_COLUMN}">
                                        <td align="left" width="{$$RECEIPT_UNIT_WIDTH}">
                                            <p><trf-expression value="{ifset(valueinfo('UnitsOfMeasure',$line.unit).title)}"/></p>
                                        </td>
                                    </trf-if>
                                    <!--
                                        If the description is not shown in it's own column, a column is used to show the article code / article source code
                                        and the description in the same column
                                    -->
                                    <td width="{!$$RECEIPT_ARTICLES_SHOW_DESCRIPTION_COLUMN?$width_description:$$RECEIPT_ARTICLE_WIDTH}" align="left">
                                        <trf-choose>
                                            <trf-when test="{$$RECEIPT_ARTICLES_SHOW_SOURCEARTICLECODE}">
                                                <p><trf-expression value="{ifset($line.sourceArticleCode)~($line.articleCode)}"/></p>
                                            </trf-when>
                                            <trf-otherwise>
                                                <p><trf-expression value="{$line.articleCode}"/></p>
                                            </trf-otherwise>
                                        </trf-choose>
                                    </td>
                                    <trf-if test="{$$RECEIPT_ARTICLES_SHOW_DESCRIPTION_COLUMN}">
                                        <td align="left" width="{$width_description}">
                                            <p style="margin-left:{$column_desc_indent}"><trf-expression value="{isaddon($line)?'+ ':($showNoDiscountMarker?($$RECEIPT_ARTICLES_NO_DISCOUNT_ALLOWED_MARKER ++ ' '):'')}{ifset($line.abbrev)~($line.description)}"/></p>
                                            <trf-if test="{$bilingual}">
                                                <p style="margin-left:{$column_desc_indent}"><trf-expression value="{isaddon($line)?'+ ':''}{ifset($line.getAbbrev($fallback_language))~($line.getDescription($fallback_language))}"/></p>
                                            </trf-if>                      
                                        </td>
                                    </trf-if>
                                    <trf-choose>
                                        <trf-when test="{!($document.illegal) &amp;&amp; ($line.pricingRelevant) &amp;&amp; !($document.pricingDisabled)}">
                                            <td align="right" width="{$$RECEIPT_AMOUNT_WIDTH}">
                                                <p><trf-expression value="{formatnumber($line.price.pricePerQuantity.total,$number_format)}"/></p>
                                            </td>
                                            <td align="right" width="{$$RECEIPT_AMOUNT_WIDTH}" >
                                                <p><trf-expression value="{formatnumber($line.unmodifiedAmount.total,$number_format)}"/></p>
                                            </td>
                                        </trf-when>
                                        <trf-otherwise>
                                            <td colspan="2" align="right"/>
                                        </trf-otherwise>
                                    </trf-choose>
                                </tr>
                                <trf-variable name="colspan" value="{($$RECEIPT_ARTICLES_SHOW_DESCRIPTION_COLUMN &amp;&amp; $$RECEIPT_ARTICLES_SHOW_UNIT_COLUMN)?integer(3):(($$RECEIPT_ARTICLES_SHOW_DESCRIPTION_COLUMN || $$RECEIPT_ARTICLES_SHOW_UNIT_COLUMN)?integer(2):integer(1))}" />
                                <!-- Voided line text-->
                                <trf-variable name="voided_text" value="{($showVoidedLines &amp;&amp; $isVoided) ? ifset(posbundlestring($$RECEIPT_BUNDLE_PATH ++ 'VoidedLine',$language)~null) : null}"/>
                                <trf-variable name="voided_text_fallback" value="{($showVoidedLines &amp;&amp; $isVoided) ? ifset(posbundlestring($$RECEIPT_BUNDLE_PATH ++ 'VoidedLine',$fallback_language)~null) : null}"/>
                                <trf-if test="{$showVoidedLines &amp;&amp; $isVoided}" >
                                    <tr>
                                        <td colspan="{$colspan}" />
                                        <td colspan="3" align="left">
                                            <p><trf-expression value="{ifset($voided_text)}" /></p>
                                        </td>
                                    </tr>
                                    <trf-if test="{$bilingual}" >
                                        <tr>
                                            <td colspan="{$colspan}" />
                                            <td colspan="3" align="left">
                                                <p><trf-expression value="{ifset($voided_text_fallback)}" /></p>
                                            </td>
                                        </tr>
                                    </trf-if>
                                </trf-if>
                                <!--
                                    For default receipt: Display the article abbreviation if available, otherwise the article description.
                                    Also display the line datacaptures, reasons and / or line comments if applicable (if enabled by configuration).
                                    And display promotion and / or price information if applicable.
                                -->
                                <tr>
                                    <td colspan="{$colspan}" >
                                        <trf-if test="{$showNoDiscountMarker &amp;&amp; !$$RECEIPT_ARTICLES_SHOW_DESCRIPTION_COLUMN}">
                                            <p><trf-expression value="{($showNoDiscountMarker &amp;&amp; !$$RECEIPT_ARTICLES_SHOW_DESCRIPTION_COLUMN)?($$RECEIPT_ARTICLES_NO_DISCOUNT_ALLOWED_MARKER):''}"/></p>
                                        </trf-if>
                                    </td>
                                    <td colspan="3" align="left">
                                        <!-- Line description - only in case of default receipt. Otherwise it was printed already in the above row. -->
                                        <trf-if test="{!($$RECEIPT_ARTICLES_SHOW_DESCRIPTION_COLUMN)}">
                                            <p style="margin-left:{$column_desc_indent}"><trf-expression value="{isaddon($line)?'+ ':''}{ifset($line.getAbbrev($$ARTICLE_LANGUAGE))~($line.getDescription($$ARTICLE_LANGUAGE))}"/></p>
                                            <trf-if test="{$bilingual}">
                                                <p style="margin-left:{$column_desc_indent}"><trf-expression value="{isaddon($line)?'+ ':''}{ifset($line.getAbbrev($$ARTICLE_FALLBACK_LANGUAGE))~($line.getDescription($$ARTICLE_FALLBACK_LANGUAGE))}"/></p>                                                                                                                                    
                                            </trf-if>
                                        </trf-if>
                                        <!-- Line data capture -->
                                        <trf-if test="{$$RECEIPT_ARTICLES_CAPTURES_SHOW &amp;&amp; isset($line.displayProperties)}">
                                            <trf-foreach name="prop" list="{$line.displayProperties}">
                                                <p><trf-expression value="{ifset($line.displayProperties.($prop).!first.($$ARTICLE_LANGUAGE))}"/>: <trf-expression value="{ifset($line.displayProperties.($prop).!second.($$ARTICLE_LANGUAGE))~ifset($line.displayProperties.($prop).second)}"/></p>
                                                <trf-if test="{$bilingual}">
                                                    <p><trf-expression value="{ifset($line.displayProperties.($prop).!first.($$ARTICLE_FALLBACK_LANGUAGE))}"/>: <trf-expression value="{ifset($line.displayProperties.($prop).!second.($$ARTICLE_FALLBACK_LANGUAGE))~ifset($line.displayProperties.($prop).second)}"/></p>
                                                </trf-if>
                                            </trf-foreach>
                                        </trf-if>
                                        <!-- Line reasons -->
                                        <trf-if test="{$$RECEIPT_ARTICLES_REASONS_SHOW &amp;&amp; isset($line.reason)}">
                                            <p><trf-expression value="{$line.reason.description}"/></p>
                                            <trf-foreach name="prop" list="{$line.reason.displayProperties}">
                                                <p><trf-expression value="{$line.reason.displayProperties.{$prop}.first}"/>: <trf-expression value="{$line.reason.displayProperties.{$prop}.second}"/></p>
                                            </trf-foreach>
                                        </trf-if>
                                        <!-- Line price reasons -->
                                        <trf-if test="{$$RECEIPT_ARTICLES_REASONS_SHOW &amp;&amp; isset($line.priceReason)}">
                                            <p><trf-expression value="{$line.priceReason.description}"/></p>
                                            <trf-foreach name="prop" list="{$line.priceReason.displayProperties}">
                                                <p><trf-expression value="{$line.priceReason.displayProperties.{$prop}.first}"/>: <trf-expression value="{$line.priceReason.displayProperties.{$prop}.second}"/></p>
                                            </trf-foreach>
                                        </trf-if>
                                        <!-- Line comments -->
                                        <trf-if test="{$$RECEIPT_ARTICLES_COMMENTS_SHOW}">
                                            <trf-foreach name="prop" list="{$line.comments}">
                                                <trf-if test="{(!isset($$RECEIPT_ARTICLES_COMMENTS) || contains($$RECEIPT_ARTICLES_COMMENTS,$prop)) &amp;&amp; {ifset($$RECEIPT_ARTICLES_ARTICLE_TEXT)~true != $prop}}">
                                                    <trf-variable name="comment" value="{$line.comments.($prop)}"/>
                                                    <trf-if test="{$$RECEIPT_ARTICLES_COMMENTS_SHOW_TITLES}">
                                                        <trf-variable name="comment" value="{valueinfo('CommentTypes',$prop~'')~$prop.title}: {$comment}"/>
                                                    </trf-if>
                                                    <p><trf-expression value="{$comment}"/></p>
                                                </trf-if>
                                            </trf-foreach>
                                        </trf-if>
                                    </td>
                                </tr>
                                <trf-variable name="voided_text" value="{($showVoidedLines &amp;&amp; $isVoided) ? ifset(posbundlestring($$RECEIPT_BUNDLE_PATH ++ 'VoidedLine',$language)~null) : null}"/>
                                <!-- Line promotion from for -->
                                <trf-if test="{$$RECEIPT_ARTICLES_PROMOTION_FROM_FOR_SHOW &amp;&amp; !($document.illegal) &amp;&amp; ($line.pricingRelevant)}">
                                    <trf-variable name="maskDiscount" value="{integer(16)}"/>
                                    <trf-variable name="discount" value="{$line.getPrices($maskDiscount).pricePerQuantity.total}"/>
                                    <trf-variable name="amountInclDiscount" value="{$line.unmodifiedAmount.total}"/>
                                    <trf-variable name="lineQuantity" value="{$line.quantity}"/>
                                    <trf-variable name="promotionFromFor" value="{formatstring(posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'PromotionFromFor',$language), array({formatnumber(($amountInclDiscount / $lineQuantity)-($discount),$number_format)}, {formatnumber(($amountInclDiscount / $lineQuantity),$number_format)}))}"/>
                                    <trf-if test="{($discount != 0) &amp;&amp; (($amountInclDiscount)-($discount) &gt; ($amountInclDiscount))}">
                                        <tr>
                                            <td colspan="{$colspan}">
                                                <p/>
                                            </td>
                                            <td colspan="3" align="left" >
                                                <p><trf-expression value="{$promotionFromFor}"/></p>
                                            </td>
                                            <td/>
                                        </tr>
                                    </trf-if>
                                </trf-if>
                                <!--Line price information -->
                                <trf-if test="{$$RECEIPT_ARTICLES_SHOW_LINE_PRICE_BREAKDOWN}">
                                    <trf-if test="{($line.totalQuantity&gt;1)||($line.totalQuantity&lt;0)||($line.price.quantity&gt;1)||($line.price.quantity&lt;1)}">
                                        <trf-variable name="linePriceInfo" value="= {$line.totalQuantity} *"/>
                                        <trf-if test="{!($document.illegal) &amp;&amp; ($line.pricingRelevant)}">
                                            <trf-variable name="linePriceInfo" value="{$linePriceInfo} {formatnumber($line.price.total,$number_format)}"/>
                                            <trf-if test="{($line.price.quantity&gt;1)||($line.price.quantity&lt;1)}">
                                                <trf-variable name="linePriceInfo" value="{$linePriceInfo} / {$line.price.quantity}"/>
                                            </trf-if>
                                        </trf-if>
                                        <trf-if test="{isset($linePriceInfo)}">
                                            <tr>
                                                <td/>
                                                <td height="1">
                                                    <p style="margin-left:{$column_desc_indent}"><trf-expression value="{$linePriceInfo}"/></p>
                                                </td>
                                                <td/>
                                            </tr>
                                        </trf-if>
                                    </trf-if>
                                </trf-if>
                                <!-- Line modifiers (e.g. Discounts) -->
                                <trf-foreach name="modifier" list="{$line.modifiers}">
                                    <trf-if test="{!($modifier.generated)}">
                                        <tr>
                                            <td/>
                                            <td>
                                                 <p>-/-</p>
                                            </td>
                                            <td  align="left" >
                                                <p style="margin-left:{$column_desc_indent}"><trf-expression value="{$modifier.description}"/></p>
                                                <trf-if test="{$bilingual}">
                                                    <p style="margin-left:{$column_desc_indent}"><trf-expression value="{$modifier.getDescription($fallback_language)}"/></p>
                                                </trf-if>
                                                <trf-foreach name="prop" list="{ifset($modifier.reason.displayProperties)}">
                                                    <p><trf-expression value="{$modifier.reason.displayProperties.($prop).!first($language)}"/>: <trf-expression value="{ifset($modifier.reason.displayProperties.($prop).!second.($language))~ifset($modifier.reason.displayProperties.{$prop}.second)}"/></p>
                                                    <trf-if test="{$bilingual}">
                                                        <p><trf-expression value="{$modifier.reason.displayProperties.($prop).!first.($fallback_language)}"/>: <trf-expression value="{ifset($modifier.reason.displayProperties.($prop).!second.($fallback_language))~ifset($modifier.reason.displayProperties.{$prop}.second)}"/></p>
                                                    </trf-if>
                                                </trf-foreach>
                                            </td>
                                            <td align="right">
                                                <trf-if test="{!($document.illegal)}">
                                                    <p><trf-expression value="{formatnumber($modifier.amount.total,$number_format)}"/></p>
                                                </trf-if>
                                            </td>
                                        </tr>
                                    </trf-if>
                                </trf-foreach>
                            </trf-if>        
                            <!-- patch lines-->
                            <trf-if test="{ifset($$RECEIPT_SHOW_REVISED_LINES_IN_ARTICLES) ~ false}">
                                <trf-foreach name="patch_line" list="{$line.relatedLines}">
                                    <tr>
                                        <td>
                                            <p><trf-expression value="{$patch_line.totalQuantity}"/></p>
                                        </td>
                                        <td colspan="2" align="left" >
                                            <p><trf-expression value="{$$RECEIPT_ARTICLES_SHOW_SOURCEARTICLECODE?(ifset($patch_line.sourceArticleCode)~($patch_line.articleCode)):($patch_line.articleCode)} ({formatdate($patch_line.creationTimestamp, $date_format)})"/></p>
                                        </td>
                                    </tr>
                                </trf-foreach>
                            </trf-if>
                             <trf-variable name="subtotal" value="{$subtotal + ($line.amount.total)}"/>
                        </trf-foreach>
                        <!-- Calculate the subtotal for the line groups -->
                        <!--
                        <trf-variable name="subtotal" value="{$subtotal + ($line.amount.total)}"/>
                        -->
                        <trf-if test="{count($lineGroups)>1}">
                            <tr>
                                <td/>
                                <td colspan="{(ifset($$RECEIPT_ARTICLES_SHOW_DESCRIPTION_COLUMN)~false)?integer(3):integer(1)}">
                                    <p><b><trf-expression value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'GroupTotalAmountBlockLabel',$language)}"/></b></p>
                                </td>
                                <td/>
                                <td width="{$$RECEIPT_AMOUNT_WIDTH}" align="right">
                                    <trf-if test="{!($document.illegal)}">
                                        <p><b><trf-expression value="{formatnumber($subtotal,$number_format)}"/></b></p>
                                    </trf-if>
                                </td>
                                     
                            </tr>
                        </trf-if>
                    </trf-foreach>
                </tbody>
            </table>
        </trf-if>
    </trf-template>

    <trf-template name="$z_TEMPLATE_RECEIPT_ARTICLES_OLD">
        <trf-if test="{!$$RECEIPT_SHOW_ARTICLES_NEW}">
            <table width="{$$WIDTH_PRINTER}">
                <tbody>
                    <tr>
                        <td colspan="2">
                            <p><b><trf-expression value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++'ArticleBlockLabel',$language)}" /></b></p>
                        </td>
                        <td align="right">
                            <p><b><trf-expression value="{$document.currency}" /></b></p>
                        </td>
                    </tr>
                    <trf-variable name="lineGroup" value="{$document.lines}"/>
                    <trf-variable name="lineGroups" value="{list()}"/>
                    <trf-if test="{($document.documentType='direct_sales') || ($document.documentType='z_invoice') || ($document.documentType='z_b2c')}">
                        <trf-variable name="lineGroup" value="{list()}"/>
                        <trf-variable name="dueGroupId" value="{null}"/>
                        <trf-foreach name="line" list="{$document.lines}">
                            <trf-choose>
                                <trf-when test="{$dueGroupId=($line.dueGroupId)}">
                                    <trf-variable name="lineGroup" value="{($lineGroup) ++ !list($line)}"/>
                                </trf-when>
                                <trf-otherwise>
                                    <trf-if test="{count($lineGroup)>0}">
                                        <trf-variable name="lineGroups" value="{($lineGroups) ++ !list($lineGroup)}" />
                                    </trf-if>
                                    <trf-variable name="lineGroup" value="{list($line)}" />
                                </trf-otherwise>
                            </trf-choose>
                            <trf-variable name="dueGroupId" value="{$line.dueGroupId}"/>
                            <trf-if test="{isset($line.reason.code) }">
                                <trf-if test="{($line.reason.code = 'z_klacht')  || ($line.reason.code = 'z_wrong_buy') || ($line.reason.code = 'z_cancellation')}">
                                    <trf-variable name="$displayKlachtSign" value="{true}"/>
                                </trf-if>
                            </trf-if>
                            <trf-if test="{isset($line.priceReason.code) }">
                                <trf-if test="{($line.priceReason.code = 'z_promotion_discount') || ($line.priceReason.code = 'z_damage_discount')}">
                                    <trf-variable name="$displayKlachtSign" value="{true}"/>
                                </trf-if>
                            </trf-if>

                        </trf-foreach>
                    </trf-if>
                    <trf-if test="{count($lineGroup)>0}">
                       <trf-variable name="lineGroups" value="{($lineGroups) ++ !list($lineGroup)}" />
                    </trf-if>
                    <trf-foreach name="lineGroup" list="{$lineGroups}">
                        <trf-variable name="subtotal" value="{0}"/>
                        <trf-foreach name="line" list="{$lineGroup}">
                            <trf-if test="{isset($line.articleCode)&amp;&amp;($line.totalQuantity!=0)}">
                                <trf-variable name="indent" value="{0}" />
                                <trf-variable name="ancestor" value="{$line}" />
                                <trf-while test="{isset($ancestor)}">
                                    <trf-if test="{iscomponent($ancestor)}">
                                        <trf-variable name="indent" value="{$indent+2}" />
                                    </trf-if>
                                    <trf-variable name="ancestor" value="{getline($document, $ancestor.parentLineId)}" />
                                </trf-while>
                                <tr>
                                    <td align="left" width="{$$RECEIPT_QUANTITY_WIDTH}">
                                        <trf-choose>
                                            <trf-when test="{isset(contains($line.priceConditionIds,'zkhr')?'!':'')}">
                                                <p><trf-expression value="{contains($line.priceConditionIds,'zkhr')?'!':''}{$line.articleCode}" /></p>
                                            </trf-when>
                                            <trf-otherwise>
                                                <p><trf-expression value="{$line.articleCode}" /></p>
                                            </trf-otherwise>
                                        </trf-choose>
                                    </td>
                                    <!--
                                    <td>
                                        <p><trf-expression value="{substring('        ',0,8-length($line.articleCode))}{$line.articleCode}" /></p>
                                    </td>
                                    -->
                                    <td width="{$$WIDTH_PRINTER - $$RECEIPT_QUANTITY_WIDTH - $$RECEIPT_AMOUNT_WIDTH}">
                                        <p style="margin-left:{$indent}"><trf-expression value="{isaddon($line)?'+ ':''}{replace(({$line.abbrev~false!=''}?($line.abbrev):($line.description)),' ',' ')}" /></p>
                                        <trf-if test="{$bilingual}">
                                            <p style="margin-left:{$indent}"><trf-expression value="{isaddon($line)?'+ ':''}{ifset($line.getAbbrev($fallback_language))~($line.getDescription($fallback_language))}"/></p>
                                        </trf-if>
                                        <trf-foreach name="prop" list="{$line.displayProperties}">
                                            <trf-if test="{$prop != 'attribute(z_uom)'}">
                                                <p><trf-expression value="{$line.displayProperties.{$prop}.first}"/>: <trf-expression value="{$line.displayProperties.{$prop}.second}"/></p>
                                                 <trf-if test="{$bilingual}">
                                                    <p><trf-expression value="{ifset($line.displayProperties.($prop).first.($fallback_language))}"/>: <trf-expression value="{ifset($line.displayProperties.($prop).second.($fallback_language))~ifset($line.displayProperties.($prop).second)}"/></p>
                                                </trf-if>
                                            </trf-if>
                                        </trf-foreach>
                                        <trf-if test="{isset($line.reason)}">
                                            <p><trf-expression value="{$line.reason.description}"/></p>
                                            <trf-if test="{$bilingual}">
                                                <p><trf-expression value="{$line.reason.getDescription($fallback_language)}"/></p>
                                            </trf-if>
                                            <trf-foreach name="prop" list="{$line.reason.displayProperties}">
                                                <p><trf-expression value="{$line.reason.displayProperties.{$prop}.first}"/>: <trf-expression value="{$line.reason.displayProperties.{$prop}.second}"/></p>
                                                <trf-if test="{$bilingual}">
                                                    <p><trf-expression value="{$line.displayProperties.{$prop}.first.($fallback_language)}"/>: <trf-expression value="{ifset($line.displayProperties.{$prop}.second.($fallback_language))~ifset($line.displayProperties.{$prop}.second)}"/></p>
                                                </trf-if>
                                            </trf-foreach>
                                        </trf-if>
                                        <trf-if test="{isset($line.priceReason)}">
                                            <trf-if test="{$line.priceReason.code != 'z_manual_price'}">
                                                <p><trf-expression value="{$line.priceReason.description}"/></p>
                                                <trf-if test="{$bilingual}">
                                                    <p><trf-expression value="{$line.priceReason.getDescription($fallback_language)}"/></p>
                                                </trf-if>
                                                <trf-foreach name="prop" list="{$line.priceReason.displayProperties}">
                                                    <p><trf-expression value="{$line.priceReason.displayProperties.{$prop}.first}"/>: <trf-expression value="{$line.priceReason.displayProperties.{$prop}.second}"/></p>
                                                    <trf-if test="{$bilingual}">
                                                        <p><trf-expression value="{$line.displayProperties.{$prop}.first.($fallback_language)}"/>: <trf-expression value="{ifset($line.displayProperties.{$prop}.second.($fallback_language))~ifset($line.displayProperties.{$prop}.second)}"/></p>
                                                    </trf-if>
                                                </trf-foreach>
                                            </trf-if>
                                        </trf-if>
                                    </td>
                                    <td align="right" width="{$$RECEIPT_AMOUNT_WIDTH}">
                                        <trf-if test="{!iscomponent($line)}">
                                            <p><trf-expression value="{formatnumber($line.unmodifiedAmount.total,$number_format)}" /></p>
                                        </trf-if>
                                    </td>
                                </tr>
                                <trf-if test="{($line.totalQuantity&gt;1)||($line.totalQuantity&lt;0)}">
                                    <tr>
                                        <td/>

                                        <td height="1">
                                            <p style="margin-left:{$indent}"><trf-expression value="= {$line.totalQuantity} x {iscomponent($line) ? '' : formatnumber($line.price.total,$number_format)}" /></p>
                                        </td>
                                        <td/>
                                    </tr>
                                </trf-if>
                                <trf-foreach name="modifier" list="{$line.modifiers}">
                                    <trf-if test="{!($modifier.generated)}">
                                        <tr>

                                            <td>
                                                <p>-/-</p>
                                            </td>
                                            <td>
                                                <p style="margin-left:{$indent}"><trf-expression value="{$modifier.description}" /></p>
                                                <trf-foreach name="prop" list="{ifset($modifier.reason.displayProperties)}">
                                                    <p><trf-expression value="{$modifier.reason.displayProperties.{$prop}.first}"/>: <trf-expression value="{$modifier.reason.displayProperties.{$prop}.second}"/></p>
                                                    <trf-if test="{$bilingual}">
                                                        <p><trf-expression value="{$modifier.reason.displayProperties.{$prop}.first.($fallback_language)}"/>: <trf-expression value="{ifset($modifier.reason.displayProperties.{$prop}.second.($fallback_language))~ifset($modifier.reason.displayProperties.{$prop}.second)}"/></p>
                                                    </trf-if>
                                                </trf-foreach>
                                            </td>
                                            <td align="right">
                                                <p><trf-expression value="{formatnumber($modifier.amount.total,$number_format)}" /></p>
                                            </td>
                                        </tr>
                                    </trf-if>
                                </trf-foreach>
                                <!-- Line quantity details -->
                                <trf-if test="{ifset($$RECEIPT_SHOW_LINE_QUANTITY_DETAILS)~false}">
                                    <tr>
                                        <td>
                                            <p/>
                                        </td>
                                        <td colspan="2">
                                            <p>
                                                <trf-expression value="{formatnumber($line.quantity,$quantity_format)} {$line.unit} * {formatnumber($line.price.pricePerQuantity.total,$number_format)}" />
                                            </p>
                                        </td>
                                    </tr>
                                </trf-if>
                                <!-- Line tax details -->
                                <trf-if test="{ifset($$RECEIPT_SHOW_LINE_TAX_DETAILS)~false}">
                                    <trf-variable name="tax_amount" value="{0.0}" />
                                    <trf-foreach name="condition" list="{$line.distributedConditions}">
                                        <trf-if test="{($condition.amount.total)=($condition.amount.taxes)}">
                                            <trf-variable name="tax_amount" value="{$tax_amount+($condition.amount.total)}" />
                                        </trf-if>
                                    </trf-foreach>
                                    <tr>
                                        <td>
                                            <p/>
                                        </td>
                                        <td colspan="2">
                                            <table>
                                                <tbody>
                                                    <tr>
                                                        <td width="{ifset($$RECEIPT_LINE_TAX_DETAILS_WIDTH)~$$RECEIPT_AMOUNT_WIDTH}" align="right">
                                                            <p><trf-expression value="{formatnumber(($line.netAmount.total)-$tax_amount,$number_format)}" /></p>
                                                        </td>
                                                        <td width="{ifset($$RECEIPT_LINE_TAX_DETAILS_WIDTH)~$$RECEIPT_AMOUNT_WIDTH}" align="right">
                                                            <p><trf-expression value=" {formatnumber($line.taxPercentage,$percentage_format)}%: " /></p>
                                                        </td>
                                                        <td width="{ifset($$RECEIPT_LINE_TAX_DETAILS_WIDTH)~$$RECEIPT_AMOUNT_WIDTH}" align="right">
                                                            <p><trf-expression value="{formatnumber($tax_amount,$number_format)}" /></p>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </td>
                                    </tr>
                                </trf-if>
                            </trf-if>
                            <trf-variable name="subtotal" value="{$subtotal + ($line.amount.total)}"/>
                       </trf-foreach>
                        <trf-if test="{count($lineGroups)>1}">
                            <tr>

                                <td/>
                                <td><p><b><trf-expression value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++'GroupTotalAmountBlockLabel',$language)}" /></b></p></td>
                                <td align="right"><p><b><trf-expression value="{formatnumber($subtotal,$number_format)}" /></b></p></td>
                                <td/>
                            </tr>
                        </trf-if>
                    </trf-foreach>
                </tbody>
            </table>
        </trf-if>
    </trf-template>
    <!--
        =============
        Split the payments as mixed payments and full discount payments.
        =============
    -->
    <trf-template name="$TEMPLATE_SPLIT_PAYMENTS">
        <trf-variable name="payments_with_full_discount" value="{list()}" />
        <trf-variable name="payments_with_non_full_discount" value="{list()}" />
        <!-- Transaction discounts (if discount = 100% payment) -->
        <trf-foreach name="payment" list="{$document.allPayments}">
            <trf-variable name="payment_discount_total" value="{0.0}" />
            <trf-foreach name="modifier" list="{$payment.modifiers}">
                <trf-if test="{containsmode($modifier.amount,$$MODE_MASK_DISCOUNT)}">
                    <trf-variable name="payment_discount_total" value="{$payment_discount_total + ($modifier.amount.all)}" />
                </trf-if>
            </trf-foreach>
            <trf-variable name="payment_payment_total" value="{$payment.amount.total - $payment_discount_total}" />
            <trf-choose>
                <trf-when test="{$$RECEIPT_DISPLAY_FULL_DISCOUNT_PAYMENTS_AS_DISCOUNTS &amp;&amp; ($payment_payment_total = 0.0) &amp;&amp; {!ifset($payment.status.void)~true}}">
                    <trf-variable name="payments_with_full_discount" value="{$payments_with_full_discount +! $payment}" />
                </trf-when>
                <trf-otherwise>
                    <trf-variable name="payments_with_non_full_discount" value="{$payments_with_non_full_discount +! $payment}" />
                </trf-otherwise>
            </trf-choose>
        </trf-foreach>
    </trf-template>

    <!--
        =============
        Total amounts
        =============
    -->
    <trf-template name="$TEMPLATE_TOTAL_AMOUNTS">
        <trf-apply template="$TEMPLATE_AUX_DETERMINE_CANCEL_ORDER" />
        <trf-apply template="$TEMPLATE_SPLIT_PAYMENTS" />
        <trf-if test="{$$RECEIPT_SHOW_TOTAL_AMOUNTS &amp;&amp; !($document.pricingDisabled)}">
            <!--
            <trf-apply template="$TEMPLATE_EMPTY_LINE" />
            -->
            <trf-variable name="width_description" value="{$$WIDTH_PRINTER - $$RECEIPT_INDENT - (2*$$RECEIPT_AMOUNT_WIDTH)}" />
            <trf-variable name="total_discount" value="{0.0}"/>
            <trf-variable name="show_subtotal_line" value="{false}"/>
            <trf-foreach name="modifier" list="{$document.modifiers}">
                <trf-variable name="condition_info" value="{valueinfo('FinancialConditions',$modifier.conditionId)}" />
                <trf-variable name="is_downpayment" value="{ifset(entryinfo($condition_info,'condition_type').enumValue.code = 'payment')~false}" />
                <trf-variable name="is_reservation" value="{ifset(entryinfo($condition_info,'condition_type').enumValue.code = 'reservation')~false}" />
                <trf-if test="{!$is_downpayment &amp;&amp; !$is_reservation}">
                    <trf-variable name="show_subtotal_line" value="{true}"/>
                </trf-if>
            </trf-foreach>
            <trf-if test="{count($payments_with_full_discount) &gt; 0}">
                <trf-variable name="show_subtotal_line" value="{true}"/>
            </trf-if>
            <table>
                <tbody>
                    <!-- Subtotal -->
                    <trf-if test="{$show_subtotal_line}">
                        <tr>
                            <td width="{$$RECEIPT_INDENT}">
                                <p/>
                            </td>
                            <td colspan="2" width="{$width_description + $$RECEIPT_AMOUNT_WIDTH}">
                                <p><b><trf-expression value="{posbundlestring($$RECEIPT_BUNDLE_PATH ++ 'SubtotalAmountLabel',$language)}" /></b></p>
                            </td>
                            <td width="{$$RECEIPT_AMOUNT_WIDTH}" align="right">
                                <trf-if test="{!($document.illegal)}">
                                    <p><trf-expression value="{formatnumber($document.unmodifiedAmount.total,$number_format)}" /></p>
                                </trf-if>
                            </td>
                        </tr>
                    </trf-if>
                     <!-- Non-down-payment modifiers and down-payment modifiers handling -->
                    <trf-variable name="total_downpayment_amount" value="{0}"/>
                    <trf-foreach name="modifier" list="{$document.modifiers}">
                        <trf-variable name="condition_info" value="{valueinfo('FinancialConditions',$modifier.conditionId)}" />
                        <trf-variable name="is_downpayment" value="{ifset(entryinfo($condition_info,'condition_type').enumValue.code = 'payment')~false}" />
                        <trf-variable name="is_reservation" value="{ifset(entryinfo($condition_info,'condition_type').enumValue.code = 'reservation')~false}" />
                        <trf-if test="{!$is_downpayment &amp;&amp; !$is_reservation}">
                            <tr>
                                <td width="{$$RECEIPT_INDENT}">
                                    <p>-/-</p>
                                </td>
                                <td colspan="2" width="{$width_description + $$RECEIPT_AMOUNT_WIDTH}">
                                    <p><trf-expression value="{$modifier.description}" /></p>
                                    <trf-foreach name="prop" list="{ifset($modifier.reason.displayProperties)}">
                                        <p><trf-expression value="{$modifier.reason.displayProperties.{$prop}.first}" />: <trf-expression value="{$modifier.reason.displayProperties.{$prop}.second}" /></p>
                                    </trf-foreach>
                                </td>
                                <td width="{$$RECEIPT_AMOUNT_WIDTH}" align="right">
                                    <trf-if test="{!($document.illegal)}">
                                        <p><trf-expression value="{formatnumber($modifier.amount.total,$number_format)}" /></p>
                                        <trf-variable name="total_discount" value="{($modifier.amount.total) + ($total_discount)}" />
                                    </trf-if>
                                </td>
                            </tr>
                        </trf-if>
                        <trf-if test="{$is_downpayment}">
                            <!-- Change the sign of the downpayment amount -->
                            <trf-variable name="total_downpayment_amount" value="{$total_downpayment_amount - ($modifier.amount.total)}"/>
                        </trf-if>
                    </trf-foreach>
                    <!-- Payments with full discount -->
                    <trf-foreach name="payment" list="{$payments_with_full_discount}">
                        <trf-variable name="payment_amount_total" value="{formatnumber(-($payment.amount.total),$number_format)}" />
                        <trf-apply template="$z_TEMPLATE_AUX_PAYMENT_PAYMENT_LINE" />
                        <trf-variable name="$total_discount_payment" value="{$$total_discount_payment + ($payment.amount.total)}" /> <!-- CTCR19120181 -->
                    </trf-foreach>
                    <!-- Taxes -->
                    <trf-if test="{ifset(($document.taxMode) = (xv_tax_exclusive))~false}">
                        <tr>
                            <td width="{$$RECEIPT_INDENT}"/>
                            <td colspan="2" width="{$width_description + $$RECEIPT_AMOUNT_WIDTH}">
                                <p><trf-expression value="{posbundlestring($$RECEIPT_BUNDLE_PATH ++ 'TaxesAmountBlockLabel',$language)}" /></p>
                            </td>
                            <td width="{$$RECEIPT_AMOUNT_WIDTH}" align="right">
                                <trf-if test="{!($document.illegal)}">
                                    <p><trf-expression value="{formatnumber($document.distributedAmount.taxes,$number_format)}" /></p>
                                </trf-if>
                            </td>
                        </tr>
                    </trf-if>
                    <!-- Total -->
                    <trf-variable name="total_correction_amount" value="{0}"/>
                    <trf-foreach name="payment" list="{$payments_with_full_discount}">
                        <trf-variable name="total_correction_amount" value="{$total_correction_amount + ($payment.amount.total)}"/>
                    </trf-foreach>
                    <tr>
                        <td width="{$$RECEIPT_INDENT}"/>
                        <td colspan="2" width="{$width_description + $$RECEIPT_AMOUNT_WIDTH}">
                            <p style="font-stretch-horizonal:wide;"><b><trf-expression value="{posbundlestring($$RECEIPT_BUNDLE_PATH ++ 'TotalAmountsTitle',$language)}" /></b></p>
                        </td>
                        <td width="{$$RECEIPT_AMOUNT_WIDTH}" align="right">
                            <trf-if test="{!($document.illegal)}">
                                <p><b><trf-expression value="{formatnumber((($document.totalAmount.total)-$total_correction_amount)+$total_downpayment_amount,$number_format)}" /></b></p>
                            </trf-if>
                        </td>
                    </tr>
                    <!-- Total to be paid -->
                    <trf-if test="{$document.targetAmount!=null}">
                       <tr>
                            <td width="{$$RECEIPT_INDENT}"/>
                            <td colspan="2" width="{$width_description + $$RECEIPT_AMOUNT_WIDTH}">
                                <p style="font-stretch-horizonal:wide;"><b><trf-expression value="{posbundlestring($$RECEIPT_BUNDLE_PATH ++ 'TotalToBePaidLabel',$language)}" /></b></p>
                            </td>
                            <td width="{$$RECEIPT_AMOUNT_WIDTH}" align="right">
                                <trf-if test="{!($document.illegal)}">
                                    <p><b><trf-expression value="{formatnumber(($document.targetAmount)-$total_correction_amount,$number_format)}" /></b></p>
                                </trf-if>
                            </td>
                        </tr>
                    </trf-if>
                </tbody>
            </table>
        </trf-if>
    </trf-template>

    <!--
        ========
        Payments
        ========
    -->
    <trf-template name="$z_TEMPLATE_PAYMENTS">
        <trf-apply template="$TEMPLATE_SPLIT_PAYMENTS" />
        <trf-if test="{$$RECEIPT_SHOW_PAYMENTS &amp;&amp; !($document.pricingDisabled)}">
            <trf-variable name="width_description" value="{$$WIDTH_PRINTER - $$RECEIPT_INDENT - (2*$$RECEIPT_AMOUNT_WIDTH)}" />
            <trf-variable name="normal_payments" value="{list()}" />
            <trf-variable name="change_payments" value="{list()}" />
            <trf-variable name="voided_payments" value="{list()}" />
            <trf-variable name="saving_as_payment" value="{list()}" />
            <trf-variable name="pin_payment" value="{false}" />
            <trf-variable name="wisselgeld_payment" value="{false}" />
            <!-- Down-payment modifiers -->
            <trf-foreach name="modifier" list="{$document.modifiers}">
                <trf-variable name="condition_info" value="{valueinfo('FinancialConditions',$modifier.conditionId)}" />
                <trf-variable name="is_downpayment" value="{ifset(entryinfo($condition_info,'condition_type').enumValue.code = 'payment')~false}" />
                <trf-if test="{$is_downpayment}">
                    <!-- CTCR19120181 -->
                    <trf-variable name="normal_payments" value="{$normal_payments +! map('description',$modifier.description,'amount',$modifier.amount.negate(),'displayProperties',null,'comments',null,'modifiers',list($modifier),'tenderType',null,'rounding',({false}))}" />
                    <!-- <trf-variable name="normal_payments" value="{$normal_payments +! map('description',$modifier.description,'amount',$modifier.amount,'displayProperties',null,'comments',null)}" /> -->
                </trf-if>
            </trf-foreach>
            <!-- Payments -->
            <trf-foreach name="payment" list="{$payments_with_non_full_discount}">
                <trf-variable name="tender_info" value="{valueinfo('TenderTypes',$payment.tenderType)}" />
                <trf-variable name="is_change" value="{($payment.amount.total &lt; 0) &amp;&amp; ifset(entryinfo($tender_info,'is_change').booleanValue)~false}" />
                <trf-if test="{!ifset($payment.status.void)~true}">
                    <trf-choose>
                        <trf-when test="{$is_change}">
                            <trf-variable name="change_payments" value="{$change_payments +! $payment}" />
                        </trf-when>
                        <trf-when test="{$$RECEIPT_PAYMENTS_SHOW_ROUNDING || !($payment.rounding)}">
                            <trf-variable name="normal_payments" value="{$normal_payments +! $payment}" />
                        </trf-when>
                    </trf-choose>
                </trf-if>
                <trf-if test="{ifset($payment.status.void)~false}">
                    <trf-if test="{$$RECEIPT_PAYMENTS_SHOW_ROUNDING || !($payment.rounding)}">
                        <trf-variable name="voided_payments" value="{$voided_payments +! $payment}" />
                    </trf-if>
                </trf-if>
            </trf-foreach>
            <!-- Savings as payments (note that normal payments are not void) -->
            <trf-variable name="linked_saving_ids" value="{list()}" />
            <trf-foreach name="payment" list="{$payments_with_full_discount}">
                <trf-if test="{isset($payment.linkedSavingId)}">
                    <trf-variable name="linked_saving_ids" value="{$linked_saving_ids +! ($payment.linkedSavingId)}" />
                </trf-if>
            </trf-foreach>
            <trf-foreach name="payment" list="{$normal_payments}">
                <trf-if test="{isset($payment.linkedSavingId)}">
                    <trf-variable name="linked_saving_ids" value="{$linked_saving_ids +! ($payment.linkedSavingId)}" />
                </trf-if>
            </trf-foreach>
            <trf-foreach name="saving" list="{$document.savings}">
                <trf-if test="{!($saving.status.void) &amp;&amp; ($saving.type.payment) &amp;&amp; !contains($linked_saving_ids,$saving.savingId)}">
                    <trf-variable name="saving_as_payment" value="{$saving_as_payment +! $saving}" />
                </trf-if>
            </trf-foreach>
            <!-- Display -->
            <trf-if test="{(count($normal_payments) &gt; 0) || (count($change_payments) &gt; 0) || (count($saving_as_payment) &gt; 0)}">
                <!--
                <trf-apply template="$TEMPLATE_EMPTY_LINE" />
                -->
                <p><b><trf-expression value="{posbundlestring($$RECEIPT_BUNDLE_PATH ++ 'PaymentsTitle',$language)}" /></b></p>
                <table>
                    <tbody>
                        <trf-foreach name="payment" list="{$normal_payments}">
                            <trf-apply template="$z_TEMPLATE_AUX_PAYMENT" />
                        </trf-foreach>
                        <trf-foreach name="saving" list="{$saving_as_payment}">
                                <trf-apply template="$TEMPLATE_AUX_SAVING_AS_PAYMENT" />
                        </trf-foreach>
                        <trf-foreach name="payment" list="{$change_payments}">
                            <trf-apply template="$z_TEMPLATE_AUX_PAYMENT" />
                        </trf-foreach>
                        <!-- Payment remaining -->
                        <trf-if test="{!($document.illegal) &amp;&amp; ($document.sumAmount.total!=0.0)}">
                            <tr>
                                <td width="{$$RECEIPT_INDENT}" />
                                <td colspan="2" width="{$width_description + $$RECEIPT_AMOUNT_WIDTH}">
                                    <p><b><trf-expression value="{posbundlestring($$RECEIPT_BUNDLE_PATH ++ 'PaymentRemaining',$language)}" /></b></p>
                                </td>
                                <td width="{$$RECEIPT_AMOUNT_WIDTH}" align="right">
                                    <trf-variable name="payment_remaining_amount" value="{$is_cancel_order ? ($document.getSumAmount(true).total) : ($document.sumAmount.total)}" />
                                    <p><b><trf-expression value="{formatnumber($payment_remaining_amount,$number_format)}" /></b></p>
                                </td>
                            </tr>
                        </trf-if>
                    </tbody>
                </table>
            </trf-if>
            <!-- Print the voided payments -->
            <trf-if test="{(count($voided_payments) &gt; 0) &amp;&amp; $$RECEIPT_PAYMENTS_SHOW_VOIDED_PAYMENTS}">
                <!--
                <trf-apply template="$TEMPLATE_EMPTY_LINE" />
                -->
                <p><b><trf-expression value="{posbundlestring($$RECEIPT_BUNDLE_PATH ++ 'VoidedPaymentsTitle',$language)}" /></b></p>
                <table>
                    <tbody>
                        <trf-foreach name="payment" list="{$voided_payments}">
                           <trf-apply template="$z_TEMPLATE_AUX_PAYMENT" />
                        </trf-foreach>
                    </tbody>
                </table>
            </trf-if>
        </trf-if>
    </trf-template>

    <trf-template name="$TEMPLATE_AUX_DETERMINE_CANCEL_ORDER">
        <trf-variable name="is_document_target_amount_zero" value="{$document.targetAmount = 0.0}" />
        <trf-variable name="is_document_return" value="{tostring($document.salesType) = 'RETURN'}" />
        <trf-variable name="is_cancel_order" value="{$is_document_target_amount_zero &amp;&amp; $is_document_return}" />
    </trf-template>

    <trf-template name="$z_TEMPLATE_AUX_PAYMENT">
        <trf-variable name="payment_amount_total" value="{formatnumber($payment.amount.total,$number_format)}" />
        <trf-apply template="$z_TEMPLATE_AUX_PAYMENT_PAYMENT_LINE" />
        <!-- Payment modifiers -->
        <trf-variable name="payment_discount_total" value="{0.0}" />
        <trf-if test="{isset($payment.modifiers)}" >
            <trf-foreach name="modifier" list="{$payment.modifiers}">
                <trf-if test="{containsmode($modifier.amount,$$MODE_MASK_DISCOUNT)}">
                    <trf-variable name="payment_discount_total" value="{$payment_discount_total + ($modifier.amount.all)}" />
                </trf-if>
            </trf-foreach>
        </trf-if>
        <trf-if test="{($payment_discount_total != 0.0) &amp;&amp; {!ifset($payment.status.void)~true}}">
            <trf-if test="{$payment_discount_total!=($payment.amount.total)}">
                <tr>
                    <td/>
                    <td>
                        <p><trf-expression value="{posbundlestring($$RECEIPT_BUNDLE_PATH ++ 'OfWhichPayment')}" /></p>
                    </td>
                    <td align="right">
                        <p><trf-expression value="{formatnumber(($payment.amount.total)-$payment_discount_total,$number_format)}" /></p>
                    </td>
                    <td/>
                </tr>
            </trf-if>
            <tr>
                <td width="{$$RECEIPT_INDENT}">
                    <p><trf-expression value="{$$RECEIPT_NO_TAX_MARKER}" /></p>
                </td>
                <td width="{$width_description}">
                    <p><trf-expression value="{posbundlestring($$RECEIPT_BUNDLE_PATH ++ 'OfWhichDiscount')}" /></p>
                </td>
                <td width="{$$RECEIPT_AMOUNT_WIDTH}" align="right">
                    <p><trf-expression value="{formatnumber($payment_discount_total,$number_format)}" /></p>
                </td>
                <td width="{$$RECEIPT_AMOUNT_WIDTH}"/>
            </tr>
        </trf-if>
    </trf-template>

    <trf-template name="$z_TEMPLATE_AUX_PAYMENT_PAYMENT_LINE">
        <!-- \/ CTCR19120181 -->
        <trf-if test="{isset($payment.tenderType)&amp;&amp;!contains($$non_cash_payments,ifset($payment.tenderType))}">
            <!-- <trf-variable name="$totalNonCashPayments" value="{$$totalNonCashPayments + ($payment.amount.total)}" /> -->
            <trf-variable name="$totalNonCashPayments" value="{$$totalNonCashPayments + ($payment.amount.payments)}" /> <!-- CTAC20030917 -->
        </trf-if>
        <trf-choose>
            <trf-when test="{$$RECEIPT_PAYMENTS_SHOW_ROUNDED_TOTAL &amp;&amp; ($payment.rounding)}">
                <tr>
                    <td width="{$$RECEIPT_INDENT}">
                    </td>
                    <td colspan="2" width="{$width_description}">
                        <p><trf-expression value="{posbundlestring($$RECEIPT_BUNDLE_PATH ++ 'TotalCashToBePaidBeforeRounding',$language)}" /></p>
                        <trf-if test="{$bilingual}">
                            <p><trf-expression value="{posbundlestring($$RECEIPT_BUNDLE_PATH ++ 'TotalCashToBePaidBeforeRounding',$fallback_language)}" /></p>                                                                                                
                        </trf-if>
                    </td>
                    <td width="{$$RECEIPT_AMOUNT_WIDTH}" align="right">
                        <!-- unrounded total to pay by cash -->
                        <p><trf-expression value="{formatnumber(($document.totalAmount.total) - $$total_discount_payment - $$totalNonCashPayments,$number_format)}" /></p>
                    </td>
                </tr>
                <tr>
                    <td width="{$$RECEIPT_INDENT}">
                    </td>
                    <td colspan="2" width="{$width_description}">
                        <p><trf-expression value="{posbundlestring($$RECEIPT_BUNDLE_PATH ++ 'TotalCashToBePaidAfterRounding',$language)}" /></p>
                        <trf-if test="{$bilingual}">
                            <p><trf-expression value="{posbundlestring($$RECEIPT_BUNDLE_PATH ++ 'TotalCashToBePaidAfterRounding',$fallback_language)}" /></p>
                        </trf-if>
                    </td>
                    <td width="{$$RECEIPT_AMOUNT_WIDTH}" align="right">
                        <!-- rounded total to pay by cash -->
                        <p><trf-expression value="{formatnumber((($document.totalAmount.total) - $$total_discount_payment - $$totalNonCashPayments) - ($payment.amount.total),$number_format)}" /></p>
                    </td>
                </tr>
            </trf-when>
            <trf-otherwise>
            <!-- /\ CTCR19120181 -->
                <trf-variable name="tender_info" value="{ifset(valueinfo('TenderTypes',$payment.tenderType))}" />
                <tr>
                    <td width="{$$RECEIPT_INDENT}">
                        <p><trf-expression value="{{!ifset($payment.status.void)~true}&amp;&amp;(($payment.amount.modes)&amp;64!=64)?$$RECEIPT_NO_TAX_MARKER:''}" /></p>
                    </td>
                    <td colspan="2" width="{$width_description + $$RECEIPT_AMOUNT_WIDTH}">
                        <trf-if test="{!(isset($payment.modifiers))}">
                            <p><trf-expression value="{$payment.description} " /></p>
                        </trf-if>
                        <trf-if test="{(isset($payment.modifiers))}">
                            <trf-choose>
                                <trf-when test="{($payment.amount.total&lt;0) &amp;&amp; (ifset(entryinfo($tender_info,'is_change').booleanValue)~false) &amp;&amp;(($payment.amount.modes)&amp;64=64)}">
                                    <trf-variable name="wisselgeld_payment" value="{true}" />
                                    <p><trf-expression value="{posbundlestring($$RECEIPT_BUNDLE_PATH ++ 'ReceiptChange',$language)} ({$payment.getDescription($language)})" /></p>
                                    <trf-if test="{$bilingual}">
                                        <p><trf-expression value="{posbundlestring($$RECEIPT_BUNDLE_PATH ++ 'ReceiptChange',$fallback_language)} ({$payment.getDescription($fallback_language)})" /></p>
                                    </trf-if>
                                </trf-when>
                                <trf-when test="{{ifset(contains(ifset($$RECEIPT_PAYMENTS_SHOW_CARD_TYPES)~true,ifset($payment.card.cardType)))}&amp;&amp;isset($payment.card.cardId)}">
                                    <trf-variable name="valueInfo" value="{valueinfo('CardTypes',ifset($payment.card.cardType)~null)}" />
                                    <p><trf-expression value="{gettitle($valueInfo~'',$language)++' '}{obfuscatecardid($payment.card)}" /></p>
                                    <trf-if test="{$bilingual&amp;&amp;isset($valueInfo)}">
                                        <p><trf-expression value="{gettitle($valueInfo,$fallback_language)}" /></p>
                                    </trf-if>
                                </trf-when>
                                <trf-otherwise>
                                    <trf-if test="{$payment.tenderType = 'z_pin'}" >
                                        <trf-variable name="pin_payment" value="{true}" />
                                    </trf-if>
                                    <p><trf-expression value="{ifset($payment.getDescription($language))~($payment.description)}" /></p>
                                    <trf-if test="{$bilingual}">
                                        <p><trf-expression value="{ifset($payment.getDescription($fallback_language))}" /></p>
                                    </trf-if>
                                </trf-otherwise>
                            </trf-choose>
                        </trf-if>
                        <trf-foreach name="prop" list="{$payment.displayProperties}">
                            <p><trf-expression value="{$payment.displayProperties.{$prop}.first}" />: <trf-expression value="{$payment.displayProperties.{$prop}.second}" /></p>
                        </trf-foreach>
                        <trf-foreach name="prop" list="{$payment.comments}">
                            <p><trf-expression value="{valueinfo('CommentTypes',$prop~'')~$prop.title}" />: <trf-expression value="{$payment.comments.{$prop}}" /></p>
                        </trf-foreach>
                    </td>
                    <td width="{$$RECEIPT_AMOUNT_WIDTH}" align="right">
                        <p><trf-expression value="{$payment_amount_total}" /></p>
                    </td>
                </tr>
            </trf-otherwise> <!-- /\ CTCR19120181 -->
        </trf-choose> <!-- /\ CTCR19120181 -->
    </trf-template>

    <trf-template name="$TEMPLATE_AUX_SAVING_AS_PAYMENT">
        <trf-if test="{$saving.amount.total != 0.0}">
            <tr>
                <td width="{$$RECEIPT_INDENT}" />
                <td colspan="2" width="{$width_description + $$RECEIPT_AMOUNT_WIDTH}">
                    <trf-choose>
                        <trf-when test="{($saving.amount.total&lt;0)&amp;&amp;(($saving.amount.modes)&amp;64=64)}">
                            <p><trf-expression value="{posbundlestring($$RECEIPT_BUNDLE_PATH ++ 'ReceiptChange',$language)} ({$saving.getDescription($language)})" /></p>
                            <trf-if test="{$bilingual}">
                                <p><trf-expression value="{posbundlestring($$RECEIPT_BUNDLE_PATH ++ 'ReceiptChange',$fallback_language)} ({$saving.getDescription($fallback_language)})" /></p>
                            </trf-if>
                        </trf-when>
                        <trf-when test="{{ifset(contains(ifset($$RECEIPT_PAYMENTS_SHOW_CARD_TYPES)~true,ifset($saving.card.cardType)))}&amp;&amp;isset($saving.card.cardId)}">
                            <trf-variable name="valueInfo" value="{valueinfo('CardTypes',ifset($saving.card.cardType)~null)}" />
                            <p><trf-expression value="{gettitle($valueInfo~'',$language)++' '}{obfuscatecardid($saving.card)}" /></p>
                            <trf-if test="{$bilingual&amp;&amp;isset($valueInfo)}">
                                <p><trf-expression value="{gettitle($valueInfo,$fallback_language)}" /></p>
                            </trf-if>
                        </trf-when>
                        <trf-otherwise>
                            <p><trf-expression value="{$saving.getDescription($language)}" /></p>
                            <trf-if test="{$bilingual}">
                                <p><trf-expression value="{ifset($saving.getDescription($fallback_language))}" /></p>
                            </trf-if>
                        </trf-otherwise>
                    </trf-choose>
                    <trf-foreach name="prop" list="{$saving.displayProperties}">
                        <p><trf-expression value="{$saving.displayProperties.{$prop}.first}" />: <trf-expression value="{$saving.displayProperties.{$prop}.second}" /></p>
                    </trf-foreach>
                    <trf-foreach name="prop" list="{$saving.comments}">
                        <p><trf-expression value="{valueinfo('CommentTypes',$prop~'')~$prop.title}" />: <trf-expression value="{$saving.comments.{$prop}}" /></p>
                    </trf-foreach>
                </td>
                <td width="{$$RECEIPT_AMOUNT_WIDTH}" align="right">
                    <!-- Display saving with sign-change -->
                    <p><trf-expression value="{formatnumber(-1 * ($saving.amount.total),$number_format)}" /></p>
                </td>
            </tr>
        </trf-if>
    </trf-template>

    <!--
        =======
        Vouchers
        =======
    -->
    <trf-template name="$TEMPLATE_VOUCHERS">
        <trf-variable name="first" value="{true}" />
        <trf-foreach name="saving" list="{$document.savings}">
            <trf-variable name="voucher" value="{$saving.templateVoucher}" />
            <trf-variable name="display_voucher" value="{isset($voucher)}"/>
            <trf-foreach name="document_voucher" list="{$document.vouchers}">
                <trf-variable name="linked_saving" value="{$document_voucher.linkedSavingId}"/>
                <trf-if test="{$linked_saving = ($saving.savingId)}">
                    <trf-variable name="display_voucher" value="{false}"/>
                </trf-if>
            </trf-foreach>
            <trf-if test="{(ifset($saving.status.success)~true) &amp;&amp; $display_voucher}">
                <trf-if test="{$first}">
                    <trf-variable name="first" value="{false}" />
                    <!--
                    <trf-apply template="$TEMPLATE_EMPTY_LINE" />
                    -->
                    <trf-if test="{$$RECEIPT_VOUCHERS_SHOW_VOUCHERS_TITLE}">
                        <p><b><trf-expression value="{posbundlestring($$RECEIPT_BUNDLE_PATH ++ 'VoucherLabel',$language)}" /></b></p>
                    </trf-if>
                </trf-if>
                <trf-foreach name="modifier" list="{$saving.modifiers}">
                    <trf-variable name="price" value="{$modifier.price.total}"/>
                    <trf-variable name="quantity" value="{$modifier.quantity}"/>
                    <table>
                        <tbody>
                            <tr>
                                <td width="{$$RECEIPT_INDENT}" />
                                <td width="{$$WIDTH_PRINTER - $$RECEIPT_INDENT - $$RECEIPT_AMOUNT_WIDTH}">
                                    <p><trf-expression value="{$voucher.description}" /></p>
                                </td>
                                <td width="{$$RECEIPT_AMOUNT_WIDTH}" align="right">
                                    <trf-choose>
                                        <trf-when test="{$price = 0.0}">
                                            <p><trf-expression value="{$quantity}" /></p>
                                        </trf-when>
                                        <trf-when test="{$quantity = 1.0}">
                                            <p><trf-expression value="{formatnumber($price,$number_format)}" /></p>
                                        </trf-when>
                                        <trf-otherwise>
                                            <p><trf-expression value="{$quantity} x {formatnumber($price,$number_format)}"/></p>
                                        </trf-otherwise>
                                    </trf-choose>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </trf-foreach>
            </trf-if>
        </trf-foreach>
    </trf-template>

    <!--
        =======
        Savings
        =======
    -->
    <trf-template name="$TEMPLATE_SAVINGS">
        <trf-if test="{$$RECEIPT_SHOW_SAVINGS &amp;&amp; !($document.pricingDisabled)}">
            <trf-variable name="amount_in" value="{0.0}" />
            <trf-variable name="amount_out" value="{0.0}" />
            <trf-foreach name="saving" list="{$document.savings}">
                <trf-if test="{(!ifset($saving.status.void)~true) &amp;&amp; ($saving.type.saving)}">
                    <trf-choose>
                        <trf-when test="{$saving.amount.all &lt; 0}">
                            <trf-variable name="amount_out" value="{$amount_out - ($saving.amount.all)}" />
                        </trf-when>
                        <trf-otherwise>
                            <trf-variable name="amount_in" value="{$amount_in + ($saving.amount.all)}" />
                        </trf-otherwise>
                    </trf-choose>
                </trf-if>
            </trf-foreach>
            <trf-if test="{!($document.illegal)&amp;&amp;(($amount_out != 0.0)||($amount_in != 0.0))}">
                <!--
                <trf-apply template="$TEMPLATE_EMPTY_LINE" />
                -->
                <p><b><trf-expression value="{posbundlestring($$RECEIPT_BUNDLE_PATH ++ 'SavingsTitle',$language)}" /></b></p>
                <trf-variable name="width_description" value="{$$WIDTH_PRINTER - $$RECEIPT_INDENT - (2*$$RECEIPT_AMOUNT_WIDTH)}" />
                <table>
                    <tbody>
                        <trf-if test="{$amount_out != 0.0}">
                            <tr>
                                <td width="{$width_description + $$RECEIPT_AMOUNT_WIDTH}">
                                    <p><trf-expression value="{$saving.description}" /></p>
                                </td>
                                <td width="{$$RECEIPT_AMOUNT_WIDTH}" align="right">
                                    <p><trf-expression value="{formatnumber($amount_out,$number_format)}" /></p>
                                </td>
                            </tr>
                        </trf-if>
                        <trf-if test="{$amount_in != 0.0}">
                            <tr>
                                <td width="{$width_description + $$RECEIPT_AMOUNT_WIDTH}">
                                    <p><trf-expression value="{$saving.description}" /></p>
                                </td>
                                <td width="{$$RECEIPT_AMOUNT_WIDTH}" align="right">
                                    <p><trf-expression value="{formatnumber(-$amount_in,$number_format)}" /></p>
                                </td>
                            </tr>
                        </trf-if>
                    </tbody>
                </table>
            </trf-if>
        </trf-if>
    </trf-template>

    <!--
        ========
        Messages
        ========
    -->
    <trf-template name="$TEMPLATE_MESSAGES">
        <trf-if test="{$$RECEIPT_SHOW_MESSAGES}">
            <trf-variable name="message_languages" value="{$bilingual ? list(null, $language, $fallback_language) : list(null, $language)}"/>
            <trf-variable name="first" value="{true}" />
            <table>
                <tbody>
                    <trf-foreach name="message_language" list="{$message_languages}">
                        <trf-foreach name="message" list="{$document.messages}">
                            <!-- Message type must be PRINT -->
                            <trf-if test="{($message.type.print) &amp;&amp; ($message.languageCode = $message_language)}">
                                <trf-if test="{$first}">
                                    <trf-variable name="first" value="{false}" />
                                    <tr><td><trf-apply template="$TEMPLATE_EMPTY_LINE" /></td></tr>
                                </trf-if>
                                <tr>
                                    <td width="{$$WIDTH_PRINTER}" align="{$$RECEIPT_MESSAGES_ALIGN}">
                                        <p><trf-expression value="{$message.message}" /></p>
                                    </td>
                                </tr>
                            </trf-if>
                        </trf-foreach>
                    </trf-foreach>
                </tbody>
            </table>
        </trf-if>
    </trf-template>

    <!--
        ===========
        Tax summary
        ===========
    -->
    <trf-template name="$TEMPLATE_TAX_SUMMARY">
        <trf-variable name="tax_correction_map" value="{map()}" />
        <trf-foreach name="tax_summary" list="{$document.taxSummaries}">
            <trf-variable name="tax_correction_map" value="{$tax_correction_map ++! map($tax_summary.taxClass, 0.0)}"/>
        </trf-foreach>
        <trf-apply template="$TEMPLATE_SPLIT_PAYMENTS" />
        <trf-foreach name="payment" list="{$payments_with_full_discount}">
            <trf-foreach name="modifier" list="{$payment.modifiers}">
                <trf-foreach name="line" list="{$document.lines}">
                    <trf-variable name="distributedAmount" value="{($modifier.getDistributedAmount($line.lineId))}"/>
                    <!-- Get the current amounts -->
                    <trf-variable name="tax_correction_amount" value="{$tax_correction_map.($line.taxClass)}" />
                    <!-- Add an amount -->
                    <trf-variable name="tax_correction_amount" value="{$tax_correction_amount + ($distributedAmount.total)}" />
                    <!-- Push the changed amount to the map -->
                    <trf-variable name="tax_correction_map" value="{$tax_correction_map ++! map($line.taxClass, $tax_correction_amount)}"/>
                </trf-foreach>
            </trf-foreach>
        </trf-foreach>
        <trf-if test="{ifset($$RECEIPT_SHOW_TAX_SUMMARY)~false &amp;&amp; !($document.pricingDisabled) &amp;&amp; ($document.status.closed)}">
            <trf-variable name="tax_percentage_summaries" value="{list()}" />
            <trf-variable name="tax_graduate_summaries" value="{list()}" />
            <trf-variable name="display_title_boolean" value="{true}" />
            <trf-foreach name="tax_summary" list="{$document.taxSummaries}">
                <trf-choose>
                    <trf-when test="{ifset($tax_summary.hasSinglePercentage())~true}">
                       <trf-variable name="tax_percentage_summaries" value="{($tax_percentage_summaries) ++ list($tax_summary)}" />
                    </trf-when>
                    <trf-otherwise>
                        <trf-variable name="tax_graduate_summaries" value="{($tax_graduate_summaries) ++ list($tax_summary)}" />
                    </trf-otherwise>
                </trf-choose>
            </trf-foreach>
            <!-- tax summary heading -->
            <trf-variable name="tax_percentage_summaries" value="{sort($tax_percentage_summaries,comparator('percentage'))}" />
            <trf-variable name="tax_graduate_summaries" value="{sort($tax_graduate_summaries,comparator('taxClass'))}" />
            <trf-variable name="tax_summaries" value="{list()}" />
            <trf-variable name="tax_summaries" value="{($tax_summaries) ++ ($tax_percentage_summaries) ++ ($tax_graduate_summaries)}" />
            <!--
            <trf-apply template="$TEMPLATE_EMPTY_LINE" />
            -->
            <trf-variable name="receipt_display_tax_nontaxable_amount" value="{false}"/>
            <trf-if test="{$$RECEIPT_TAX_SUMMARY_SHOW_TAX_NONTAXABLE_AMOUNT = 'yes'}">
                <trf-variable name="receipt_display_tax_nontaxable_amount" value="{true}"/>
            </trf-if>
            <trf-foreach name="tax_summary" list="{$tax_summaries}">
                <trf-variable name="tax_amounts" value="{ifset($tax_summary.paymentTaxAmounts)~$tax_summary}" />
                <trf-if test="{(($tax_amounts.amount.total != 0.0) || ($tax_amounts.correctedAmount.total != 0.0) || ($tax_amounts.correctedAmount.taxes != 0.0)) &amp;&amp; ($display_title_boolean)}">
                    <!--
                    <p><b><trf-expression value="{posbundlestring($$RECEIPT_BUNDLE_PATH ++ 'TaxSummaryTitle',$language)}" /></b></p>
                    -->
                    <trf-variable name="display_title_boolean" value="{false}" />
                </trf-if>
                <trf-variable name="corrected_tax_amount" value="{($tax_amounts.nonTaxableAmount.total) - ($tax_correction_map.($tax_summary.taxClass))}"/>
                <trf-if test="{($$RECEIPT_TAX_SUMMARY_SHOW_TAX_NONTAXABLE_AMOUNT = 'auto') &amp;&amp; ($corrected_tax_amount != 0.0)}">
                    <trf-variable name="receipt_display_tax_nontaxable_amount" value="{true}"/>
                </trf-if>
            </trf-foreach>
            <table>
                <thead>
                    <trf-if test="{!($display_title_boolean)}">
                        <tr>
                            <td align="left">
                                <p><b><trf-expression value="{posbundlestring($$RECEIPT_BUNDLE_PATH ++ 'TaxSummaryTitle',$language,'')}" /></b></p>
                            </td>
                            <trf-if test="{$receipt_display_tax_nontaxable_amount}">
                                <td align="right">
                                    <p><trf-expression value="{$$RECEIPT_NO_TAX_MARKER}{posbundlestring($$RECEIPT_BUNDLE_PATH ++ 'TaxNoneHeader',$language,'')}" /></p>
                                </td>
                            </trf-if>
                            <td align="right">
                                <p><trf-expression value="{posbundlestring($$RECEIPT_BUNDLE_PATH ++ 'TaxHeader',$language,'')}" /></p>
                            </td>
                            <td align="right">
                                <p><trf-expression value="{posbundlestring($$RECEIPT_BUNDLE_PATH ++ 'TaxExclusiveHeader',$language,'')}" /></p>
                            </td>
                            <td align="right">
                                <p><trf-expression value="{posbundlestring($$RECEIPT_BUNDLE_PATH ++ 'TaxInclusiveHeader',$language,'')}" /></p>
                            </td>
                        </tr>
                    </trf-if>
                </thead>
                <!-- Total amounts variables-->
                <trf-variable name="tot_non_tax" value="{0}" />
                <trf-variable name="tot_tax" value="{0}" />
                <trf-variable name="tot_tax_excl" value="{0}" />
                <trf-variable name="tot_tax_incl" value="{0}" />
                <trf-variable name="tax_keys" value="{list()}" />
                <trf-variable name="tax_key_details" value="{map()}" />
                <trf-foreach name="tax_summary" list="{$tax_summaries}">
                    <!-- Determine amounts -->
                    <trf-variable name="tax_amounts" value="{ifset($tax_summary.paymentTaxAmounts)~$tax_summary}" />
                    <trf-variable name="non_tax" value="{($tax_amounts.nonTaxableAmount.total) - ($tax_correction_map.($tax_summary.taxClass))}" />
                    <trf-variable name="tax" value="{$tax_amounts.correctedAmount.taxes}" />
                    <trf-variable name="tax_excl" value="{($tax_amounts.correctedAmount.total) - ($tax_amounts.correctedAmount.taxes)}" />
                    <trf-variable name="tax_incl" value="{$tax_amounts.correctedAmount.total}" />
                    <trf-if test="{($tax != 0.0) || ($tax_excl != 0.0) || ($tax_incl != 0.0)}">
                        <trf-variable name="description_as_key" value="{$$RECEIPT_TAX_SUMMARY_SHOW_TAX_DESCRIPTION}" />
                        <trf-if test="{!ifset($tax_summary.hasSinglePercentage())~false}">
                            <trf-variable name="description_as_key" value="{true}" />
                        </trf-if>
                        <trf-variable name="tax_desc" value="{$description_as_key ? ($tax_summary.description) : (formatnumber($tax_summary.percentage,$percentage_format) ++ '%')}" />
                        <trf-variable name="tax_key" value="{replace($tax_desc,'\\.','_')}" />
                        <trf-if test="{$$RECEIPT_TAX_SUMMARY_SHOW_TAX_CLASS}">
                            <trf-variable name="tax_key" value="{($tax_summary.taxClass) + ' ' + $tax_key}" />
                        </trf-if>
                        <trf-if test="{!contains($tax_keys,$tax_key)}">
                            <trf-variable name="tax_keys" value="{$tax_keys +! $tax_key}" />
                        </trf-if>
                        <!-- Aggregate based on key -->
                        <trf-variable name="tax_key_details.{$tax_key}.non_tax" value="{{ifset($tax_key_details.($tax_key).non_tax)~0.0} + $non_tax}" />
                        <trf-variable name="tax_key_details.{$tax_key}.tax" value="{{ifset($tax_key_details.($tax_key).tax)~0.0} + $tax}" />
                        <trf-variable name="tax_key_details.{$tax_key}.tax_excl" value="{{ifset($tax_key_details.($tax_key).tax_excl)~0.0} + $tax_excl}" />
                        <trf-variable name="tax_key_details.{$tax_key}.tax_incl" value="{{ifset($tax_key_details.($tax_key).tax_incl)~0.0} + $tax_incl}" />
                        <!-- Add to running totals -->
                        <trf-variable name="tot_non_tax" value="{$tot_non_tax + $non_tax}" />
                        <trf-variable name="tot_tax" value="{$tot_tax + $tax}" />
                        <trf-variable name="tot_tax_excl" value="{$tot_tax_excl + $tax_excl}" />
                        <trf-variable name="tot_tax_incl" value="{$tot_tax_incl + $tax_incl}" />
                    </trf-if>
               </trf-foreach>
                <!-- Determine column widths -->
                <trf-variable name="width_non_tax" value="{$$RECEIPT_TAX_SUMMARY_AMOUNT_MAX_WIDTH}" />
                <trf-variable name="width_tax" value="{$$RECEIPT_TAX_SUMMARY_AMOUNT_MAX_WIDTH}" />
                <trf-variable name="width_tax_excl" value="{$$RECEIPT_TAX_SUMMARY_AMOUNT_MAX_WIDTH}" />
                <trf-variable name="width_tax_incl" value="{$$RECEIPT_TAX_SUMMARY_AMOUNT_MAX_WIDTH}" />
                <trf-foreach name="tax_key" list="{$tax_keys}">
                    <trf-variable name="width_non_tax" value="{max($width_non_tax, length(formatnumber($tax_key_details.{$tax_key}.non_tax,$number_format)) + 1)}" />
                    <trf-variable name="width_tax" value="{max($width_tax, length(formatnumber($tax_key_details.{$tax_key}.tax,$number_format)) + 1)}" />
                    <trf-variable name="width_tax_excl" value="{max($width_tax_excl, length(formatnumber($tax_key_details.{$tax_key}.tax_excl,$number_format)) + 1)}" />
                    <trf-variable name="width_tax_incl" value="{max($width_tax_incl, length(formatnumber($tax_key_details.{$tax_key}.tax_incl,$number_format)) + 1)}" />
                </trf-foreach>
               <trf-variable name="width_non_tax" value="{max($width_non_tax, length(formatnumber($tot_non_tax,$number_format)) + 1)}" />
                <trf-variable name="width_tax" value="{max($width_tax, length(formatnumber($tot_tax,$number_format)) + 1)}" />
                <trf-variable name="width_tax_excl" value="{max($width_tax_excl, length(formatnumber($tot_tax_excl,$number_format)) + 1)}" />
                <trf-variable name="width_tax_incl" value="{max($width_tax_incl, length(formatnumber($tot_tax_incl,$number_format)) + 1)}" />
               <trf-variable name="width_description" value="{$$RECEIPT_TAX_SUMMARY_DESCRIPTION_WIDTH}" />
                <trf-if test="{$width_description = 0}" >
                    <trf-variable name="width_description" value="{$$WIDTH_PRINTER - ($receipt_display_tax_nontaxable_amount ? $width_non_tax : 0) - $width_tax - $width_tax_excl - $width_tax_incl}" />
                </trf-if>
                <tbody>
                    <trf-if test="{!($display_title_boolean)}">
                        <trf-foreach name="tax_key" list="{$tax_keys}">
                            <trf-variable name="tax_desc" value="{ replace($tax_key,'_','\\.')}" />
                            <trf-variable name="tax_details" value="{$tax_key_details.($tax_key)}" />
                            <tr>
                                <td width="{$width_description}" align="left">
                                    <p><trf-expression value="{$tax_desc}" /></p>
                                </td>
                                <trf-if test="{!($document.illegal)}">
                                    <trf-if test="{$receipt_display_tax_nontaxable_amount}">
                                        <td width="{$width_non_tax}" align="right">
                                            <p><trf-expression value="{formatnumber($tax_details.non_tax,$number_format)}" /></p>
                                        </td>
                                    </trf-if>
                                    <td width="{$width_tax}" align="right">
                                        <p><trf-expression value="{formatnumber($tax_details.tax,$number_format)}" /></p>
                                    </td>
                                    <td width="{$width_tax_excl}" align="right">
                                        <p><trf-expression value="{formatnumber($tax_details.tax_excl,$number_format)}" /></p>
                                    </td>
                                    <td width="{$width_tax_incl}" align="right">
                                        <p><trf-expression value="{formatnumber($tax_details.tax_incl,$number_format)}" /></p>
                                    </td>
                                </trf-if>
                            </tr>
                        </trf-foreach>
                        <tr>
                            <td colspan="{$$RECEIPT_TAX_SUMMARY_SHOW_TAX_CLASS ? 2 : 1}" width="{$width_description + ($$RECEIPT_TAX_SUMMARY_SHOW_TAX_CLASS ? 2 : 0)}">
                                <p style="font-stretch-horizonal:wide;"><b><trf-expression value="{posbundlestring($$RECEIPT_BUNDLE_PATH ++ 'TotalAmountsTitle',$language)}" /></b></p>
                            </td>
                            <trf-if test="{$receipt_display_tax_nontaxable_amount}">
                                <td align="right" width="{$width_non_tax}">
                                    <p><b><trf-expression value="{formatnumber($tot_non_tax,$number_format)}" /></b></p>
                                </td>
                            </trf-if>
                            <td align="right" width="{$width_tax}">
                                <p><b><trf-expression value="{formatnumber($tot_tax,$number_format)}" /></b></p>
                            </td>
                            <td align="right" width="{$width_tax_excl}">
                                <p><b><trf-expression value="{formatnumber($tot_tax_excl,$number_format)}" /></b></p>
                            </td>
                            <td align="right" width="{$width_tax_incl}">
                                <p><b><trf-expression value="{formatnumber($tot_tax_incl,$number_format)}" /></b></p>
                            </td>
                        </tr>
                    </trf-if>
                </tbody>
           </table>
        </trf-if>
    </trf-template>


    <!--
        ================
        Quantity summary
        ================
    -->
    <!-- Note that no distinction between article units is needed, so everything can be added up -->
    <trf-template name="$TEMPLATE_QUANTITY_SUMMARY">
        <trf-if test="{$$RECEIPT_SHOW_QUANTITY_SUMMARY}">
            <trf-variable name="quantity_summary" value="{list()}" />
            <trf-foreach name="line" list="{$document.lines}">
            <!-- Fill the quantity_summary var with all document lines that have an article code and are not 'deposit' or a return line  -->
                <trf-if test="{isset($line.articleCode) &amp;&amp; ($line.isCountable()) &amp;&amp; ($line.getArticleType() != 'deposit') &amp;&amp; ($line.getTotalQuantity() &gt; 0)}">
                     <trf-variable name="quantity_summary" value="{$quantity_summary +! ($line.totalQuantity)}" />
                </trf-if>
            </trf-foreach>
            <!-- Determine the total number of articles -->
            <trf-variable name="tot_quan_plus" value="{0}" />
            <trf-if test="{!($document.status.waiting) &amp;&amp; (count($quantity_summary) &gt; 0)}">
                <trf-foreach name="quantity_line" list="{$quantity_summary}">
                    <trf-variable name="tot_quan_plus" value="{{$tot_quan_plus} + {$quantity_line}}" />
                </trf-foreach>
                <!-- Print the total number -->
                <p><b><trf-expression value="{posbundlestring($$RECEIPT_BUNDLE_PATH ++ 'QuantitySummaryTitle',$language)}" />: </b><trf-expression value="{formatnumber($tot_quan_plus,$quantity_format)}" /></p>
            </trf-if>
        </trf-if>
    </trf-template>


    <!--
        ================
        Discount summary
        ================
    -->
    <trf-template name="$TEMPLATE_DISCOUNT_SUMMARY">
        <trf-if test="{$$RECEIPT_SHOW_DISCOUNT_SUMMARY &amp;&amp; !($document.status.waiting) &amp;&amp; !(ifset($is_cancel_order)~false)}">
            <trf-variable name="total_discount" value="{0.0}" />
            <trf-foreach name="line" list="{$document.lines}">
                <trf-foreach name="modifier" list="{$line.modifiers}">
                    <trf-if test="{!($modifier.generated)}">
                        <trf-variable name="total_discount" value="{$modifier.amount.total + $total_discount}" />
                    </trf-if>
                </trf-foreach>
            </trf-foreach>
            <trf-foreach name="modifier" list="{$document.modifiers}">
                <trf-variable name="condition_info" value="{valueinfo('FinancialConditions',$modifier.conditionId)}" />
                <trf-variable name="is_downpayment" value="{ifset(entryinfo($condition_info,'condition_type').enumValue.code = 'payment')~false}" />
                <trf-variable name="is_reservation" value="{ifset(entryinfo($condition_info,'condition_type').enumValue.code = 'reservation')~false}" />
                <trf-if test="{!$is_downpayment &amp;&amp; !$is_reservation}">
                    <trf-variable name="total_discount" value="{$modifier.amount.total + $total_discount}" />
                </trf-if>
            </trf-foreach>
            <!-- Transaction discounts -->
            <trf-foreach name="payment" list="{$document.payments}">
                <trf-variable name="payment_discount_total" value="{0.0}" />
                <trf-foreach name="modifier" list="{$payment.modifiers}">
                    <trf-if test="{containsmode($modifier.amount,$$MODE_MASK_DISCOUNT)}">
                        <trf-variable name="total_discount" value="{-($modifier.amount.total) + $total_discount}" />
                    </trf-if>
                </trf-foreach>
            </trf-foreach>
            <trf-if test="{$total_discount != 0.0}">
                <!--
                <trf-apply template="$TEMPLATE_EMPTY_LINE" />
                -->
                <p><b><trf-expression value="{posbundlestring($$RECEIPT_BUNDLE_PATH ++ 'DiscountSummaryTitle',$language) ++ ': ' ++ formatnumber($total_discount * -1,$number_format) ++ ' ' ++ {$document.currency}}" /></b></p>
                <trf-if test="{$bilingual}">
                    <p><b><trf-expression value="{posbundlestring($$RECEIPT_BUNDLE_PATH ++ 'DiscountSummaryTitle',$fallback_language)}" /></b></p>
                </trf-if>
            </trf-if>
        </trf-if>
    </trf-template>

    <!--
        ============
        Card summary
        ============
    -->
    <trf-template name="$z_TEMPLATE_CARD_SUMMARY">
        <trf-if test="{$$RECEIPT_SHOW_CARD_SUMMARY}">
            <trf-variable name="first" value="{true}" />
            <trf-foreach name="card" list="{$document.cards}">
                <trf-if test="{$$RECEIPT_SHOW_CARD_PAYMENTS_IN_CARD_SUMMARY || (tostring($card.source) != 'PAYMENT')}">
                    <trf-variable name="card_template" value="{ifset($$RECEIPT_CARD_SUMMARY_TEMPLATE_MAPPING.($card.cardType))}" />
                    <trf-if test="{isset($card_template)}">
                        <!--
                        <trf-apply template="$TEMPLATE_EMPTY_LINE" />
                        -->
                        <trf-if test="{$first}">
                            <p><b><trf-expression value="{posbundlestring('template.z_receipt.ZCardBalance')}" /></b></p>
                        </trf-if>
                        <trf-variable name="SHOW_BALANCE_AND_NUMBER" value="{false}" />
                        <trf-apply template="$TEMPLATE_CARD_SUMMARY_CONFIG_{$card_template}" />
                        <trf-choose>
                            <trf-when test="{$SHOW_BALANCE_AND_NUMBER}">
                                <trf-apply template="$z_AUX_TEMPLATE_CARD_SUMMARY" />
                            </trf-when>
                            <trf-otherwise>
                                <trf-apply template="$AUX_TEMPLATE_CARD_SUMMARY" />
                            </trf-otherwise>
                        </trf-choose>
                        <trf-variable name="first" value="{false}" />
                    </trf-if>
                </trf-if>
            </trf-foreach>
            <trf-if test="{!$first}">
                <trf-apply template="$TEMPLATE_EMPTY_LINE" />
            </trf-if>
        </trf-if>
    </trf-template>

    <!--
        =======================
        Card summary config all
        =======================
    -->
    <trf-template name="$TEMPLATE_CARD_SUMMARY_CONFIG_all">
        <trf-variable name="SHOW_CARD_HOLDER" value="{true}" />
        <trf-variable name="SHOW_START_BALANCE" value="{true}" />
        <trf-variable name="SHOW_START_BALANCE_DATE" value="{true}" />
        <trf-variable name="SHOW_CREDIT_TRANSACTIONS" value="{true}" />
        <trf-variable name="SHOW_INTERMEDIATE_BALANCE" value="{true}" />
        <trf-variable name="SHOW_VOUCHER_AMOUNT" value="{true}" />
        <trf-variable name="SHOW_VOUCHER_NUMBER" value="{true}" />
        <trf-variable name="SHOW_NUMBER_OF_VOUCHERS" value="{true}" />
        <trf-variable name="SHOW_DEBIT_TRANSACTIONS" value="{true}" />
        <trf-variable name="SHOW_END_BALANCE" value="{true}" />
        <trf-variable name="SHOW_CONVERSION_RATE" value="{true}" />
    </trf-template>

    <!--
        ===========================
        Card summary config minimal
        ===========================
    -->
    <trf-template name="$TEMPLATE_CARD_SUMMARY_CONFIG_minimal">
        <trf-variable name="SHOW_CARD_HOLDER" value="{false}" />
        <trf-variable name="SHOW_START_BALANCE" value="{false}" />
        <trf-variable name="SHOW_START_BALANCE_DATE" value="{false}" />
        <trf-variable name="SHOW_CREDIT_TRANSACTIONS" value="{false}" />
        <trf-variable name="SHOW_INTERMEDIATE_BALANCE" value="{false}" />
        <trf-variable name="SHOW_VOUCHER_AMOUNT" value="{false}" />
        <trf-variable name="SHOW_VOUCHER_NUMBER" value="{false}" />
        <trf-variable name="SHOW_NUMBER_OF_VOUCHERS" value="{false}" />
        <trf-variable name="SHOW_DEBIT_TRANSACTIONS" value="{false}" />
        <trf-variable name="SHOW_END_BALANCE" value="{false}" />
        <trf-variable name="SHOW_CONVERSION_RATE" value="{false}" />
    </trf-template>

    <!--
        ===========================
        Card summary config balance
        ===========================
    -->
    <trf-template name="$TEMPLATE_CARD_SUMMARY_CONFIG_balance">
        <trf-variable name="SHOW_BALANCE_AND_NUMBER" value="{true}" />
    </trf-template>

    <!--
        ===========================
        Card summary auxiliary template
        (cannot be called directly)
        ===========================
    -->
    <trf-template name="$z_AUX_TEMPLATE_CARD_SUMMARY">
        <trf-if test="{$$RECEIPT_SHOW_CARD_SUMMARY}">
            <table>
                <tbody>
                    <trf-variable name="card_summary" value="{getcardsummary($document,$card)}" />
                    <tr>
                        <td width="{$$RECEIPT_CARD_SUMMARY_SPACER_WIDTH}" />
                        <td width="{$$RECEIPT_CARD_SUMMARY_LABEL_WIDTH}">
                    <!-- <trf-when test="{isset($payment.card.cardId)}"> -->
                        <trf-variable name="valueInfo" value="{valueinfo('CardTypes',$card_summary.card.cardType)}" />
                            <p><trf-expression value="{gettitle($valueInfo,$language)++' '}" /></p>
                        <trf-if test="{$bilingual}">
                            <p><trf-expression value="{gettitle($valueInfo,$fallback_language)}" /></p>
                        </trf-if>
                     <!-- </trf-when> -->

                        </td>
                        <td width="{$$RECEIPT_CARD_SUMMARY_VALUE_WIDTH}" align="right">
                            <p><trf-expression value="{ifset(formatprice($card_summary.foreignAmounts.endBalance))}" /></p>
                        </td>
                    </tr>
                    <tr>
                        <td width="{$$RECEIPT_CARD_SUMMARY_SPACER_WIDTH}" />
                        <td colspan="2">
                            <p><trf-expression value="{ifset(obfuscatecardid($card_summary.card.cardType,$card_summary.card.cardId))}" /></p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </trf-if>
    </trf-template>

    <!--
        ===========================
        Card summary auxiliary template
        (cannot be called directly)
        ===========================
    -->
    <trf-template name="$AUX_TEMPLATE_CARD_SUMMARY">
        <trf-if test="{$$RECEIPT_SHOW_CARD_SUMMARY}">
            <table>
                <tbody>
                    <trf-variable name="card_summary" value="{getcardsummary($document,$card)}" />
                    <trf-variable name="has_credits" value="{ifset($card_summary.foreignAmounts.totalCredits.getAll() != 0.0)~false}" />
                    <trf-variable name="has_debits" value="{ifset($card_summary.foreignAmounts.totalDebits.getAll() != 0.0)~false}" />
                    <trf-variable name="foreign_currency_title" value="{ifset(valueinfo('Currencies', $card_summary.foreignAmounts.currency).title)~''}" />
                    <!-- Items to be shown -->
                    <trf-variable name="show_card_holder" value="{ifset($SHOW_CARD_HOLDER)~false}" />
                    <trf-variable name="show_start_balance" value="{ifset($SHOW_START_BALANCE)~false}" />
                    <trf-variable name="show_start_balance_date" value="{ifset($SHOW_START_BALANCE_DATE)~false}" />
                    <trf-variable name="show_credits" value="{(ifset($SHOW_CREDIT_TRANSACTIONS)~false) &amp;&amp; $has_credits}" />
                    <trf-variable name="show_debits" value="{(ifset($SHOW_DEBIT_TRANSACTIONS)~false) &amp;&amp; $has_debits}" />
                    <trf-variable name="show_intermediate_balance" value="{(ifset($SHOW_INTERMEDIATE_BALANCE)~false) &amp;&amp; $show_credits &amp;&amp; $show_debits}" />
                    <trf-variable name="show_end_balance" value="{ifset($SHOW_END_BALANCE)~false}" />
                    <trf-variable name="show_voucher_amount" value="{ifset($SHOW_VOUCHER_AMOUNT)~false}" />
                    <trf-variable name="show_voucher_number" value="{ifset($SHOW_VOUCHER_NUMBER)~false}" />
                    <trf-variable name="show_number_of_vouchers" value="{ifset($SHOW_NUMBER_OF_VOUCHERS)~false}" />
                    <trf-variable name="show_conversion_rate" value="{(ifset($SHOW_CONVERSION_RATE)~false) &amp;&amp; ($has_credits || $has_debits)}" />
                    <!-- Card description and number -->

                    <trf-variable name="card_id_title" value="{ifset(posbundlestring($$RECEIPT_CUSTOM_BUNDLE_PATH++($card.cardType)++'.CardNumber')) ~ posbundlestring($$RECEIPT_BUNDLE_PATH++'CardNumber')}" />
                    <trf-variable name="card_id" value="{ifset(obfuscatecardid($card_summary.card.cardType,$card_summary.card.cardId))}" />
                    <trf-variable name="card_id_length" value="{length($card_id)}" />
                    <trf-choose>
                        <trf-when test="{$card_id_length &lt; $$RECEIPT_CARD_SUMMARY_VALUE_WIDTH}">
                            <tr>
                                <td width="{$$RECEIPT_CARD_SUMMARY_SPACER_WIDTH}" />
                                <td width="{$$RECEIPT_CARD_SUMMARY_LABEL_WIDTH}">
                                    <p><trf-expression value="{$card_id_title}" /></p>
                                </td>
                                <td width="{$$RECEIPT_CARD_SUMMARY_VALUE_WIDTH}" align="right">
                                    <p><trf-expression value="{$card_id}" /></p>
                                </td>
                            </tr>
                        </trf-when>
                        <trf-otherwise>
                            <tr>
                                <td width="{$$RECEIPT_CARD_SUMMARY_SPACER_WIDTH}" />
                                <td width="{$$RECEIPT_CARD_SUMMARY_LABEL_WIDTH}">
                                    <p><trf-expression value="{$card_id_title}" /></p>
                                </td>
                                <td width="{$$RECEIPT_CARD_SUMMARY_VALUE_WIDTH}" />
                            </tr>
                            <tr>
                                <td width="{$$RECEIPT_CARD_SUMMARY_SPACER_WIDTH}" />
                                <td width="{$$RECEIPT_CARD_SUMMARY_LABEL_WIDTH+$$RECEIPT_CARD_SUMMARY_VALUE_WIDTH}" colspan="2" align="right">
                                    <p><trf-expression value="{$card_id}" /></p>
                                </td>
                            </tr>
                        </trf-otherwise>
                    </trf-choose>

                    <!-- if the card source is article, display the card status (the card bas been activated during this transaction) -->
                    <trf-if test="{$card.source = xv_card_source_article}">
                        <tr>
                            <td />
                            <td colspan="2">
                                <trf-choose>
                                    <trf-when test="{$card.status = xv_card_status_active}">
                                        <p><trf-expression value="{ifset(posbundlestring(($$RECEIPT_CUSTOM_BUNDLE_PATH++($card.cardType)++'.CardActivated'))) ~ posbundlestring($$RECEIPT_BUNDLE_PATH++'CardActivated')}" /></p>
                                    </trf-when>
                                    <trf-otherwise>
                                        <p><trf-expression value="{ifset(posbundlestring(($$RECEIPT_CUSTOM_BUNDLE_PATH++($card.cardType)++'.CardNotActivated'))) ~ posbundlestring($$RECEIPT_BUNDLE_PATH++'CardNotActivated')}" /></p>
                                    </trf-otherwise>
                                </trf-choose>
                            </td>
                        </tr>
                    </trf-if>
                    <!-- Cardholder -->
                    <trf-if test="{$show_card_holder &amp;&amp; isset($card.cardHolder)}">
                        <tr>
                           <td />
                           <td>
                                <p><trf-expression value="{ifset(posbundlestring($$RECEIPT_CUSTOM_BUNDLE_PATH++($card.cardType)++'.CardHolder')) ~ posbundlestring($$RECEIPT_BUNDLE_PATH++'CardHolder')}" /></p>
                            </td>
                            <td align="right">
                                <p><trf-expression value="{$card.cardHolder}" /></p>
                            </td>
                        </tr>
                    </trf-if>
                    <!-- Start balance -->
                    <trf-if test="{$show_start_balance &amp;&amp; isset($card_summary.foreignAmounts.startBalance) &amp;&amp; !($card.source = xv_card_source_article)}">
                        <tr>
                            <td />
                            <td>
                                <p><trf-expression value="{ifset(posbundlestring($$RECEIPT_CUSTOM_BUNDLE_PATH++($card.cardType)++'.Balance')) ~ posbundlestring($$RECEIPT_BUNDLE_PATH++'Balance')}" /></p>
                            </td>
                            <td align="right">
                                <p><trf-expression value="{formatprice($card_summary.foreignAmounts.startBalance)} {$foreign_currency_title}" /></p>
                            </td>
                        </tr>
                    </trf-if>
                    <!-- Start balance date  -->
                    <trf-if test="{$show_start_balance_date &amp;&amp; isset($card.balanceDate) &amp;&amp; isset($card_summary.foreignAmounts.startBalance)}">
                        <tr>
                            <td />
                            <td>
                                <p><trf-expression value="{ifset(posbundlestring($$RECEIPT_CUSTOM_BUNDLE_PATH++($card.cardType)++'.BalanceDate')) ~ posbundlestring($$RECEIPT_BUNDLE_PATH++'BalanceDate')}" /></p>
                                </td>
                            <td align="right">
                                <p><trf-expression value="{formatdate($card.balanceDate, $date_format)}" /></p>
                            </td>
                        </tr>
                    </trf-if>
                    <!-- Credit transactions -->
                    <trf-if test="{$show_credits &amp;&amp; isset($card_summary.foreignAmounts.totalCredits)}">
                        <tr>
                            <td />
                            <td>
                                <p><trf-expression value="{ifset(posbundlestring($$RECEIPT_CUSTOM_BUNDLE_PATH++($card.cardType)++'.CreditMutations')) ~ posbundlestring($$RECEIPT_BUNDLE_PATH++'CreditMutations')}" /></p>
                            </td>
                            <td align="right">
                                <p><trf-expression value="{formatprice($card_summary.foreignAmounts.totalCredits)} {$foreign_currency_title}" /></p>
                            </td>
                        </tr>
                    </trf-if>
                    <!-- Intermediate balance after credit transactions -->
                    <trf-variable name="intermediate_balance" value="{ifset($card_summary.foreignAmounts.getIntermediateBalance(false, true, false, true))}" />
                    <trf-if test="{$show_intermediate_balance &amp;&amp; isset($intermediate_balance)}">
                        <tr>
                            <td/>
                            <td>
                                <p><trf-expression value="{ifset(posbundlestring($$RECEIPT_CUSTOM_BUNDLE_PATH++($card.cardType)++'.IntermediateBalance')~posbundlestring($$RECEIPT_BUNDLE_PATH++'IntermediateBalance'))}" /></p>
                            </td>
                            <td align="right">
                                <p><trf-expression value="{formatprice($intermediate_balance)} {$foreign_currency_title}" /></p>
                            </td>
                        </tr>
                    </trf-if>
                    <!-- Generated vouchers -->
                    <trf-if test="{$show_voucher_number || $show_voucher_amount || $show_number_of_vouchers}">
                        <trf-variable name="voucher_count" value="{integer(0)}" />
                        <trf-foreach name="voucher" list="{$document.vouchers}">
                            <trf-if test="{isset($voucher)}">
                                <trf-variable name="linked_card" value="{$document.getSaving($document.getSaving($voucher.getLinkedSavingId())~null.getLinkedSavingId())~null.getCard()}" />
                                <trf-if test="{($linked_card~false.cardId) = ($card.cardId)}">
                                    <trf-variable name="voucher_count" value="{$voucher_count+1}" />
                                    <trf-if test="{$show_voucher_number &amp;&amp; isset($voucher.voucherId)}">
                                        <tr>
                                            <td />
                                            <td>
                                                <p><trf-expression value="{ifset(posbundlestring($$RECEIPT_CUSTOM_BUNDLE_PATH++($card.cardType)++'.Voucher')) ~ posbundlestring($$RECEIPT_BUNDLE_PATH++'Voucher')}" /></p>
                                            </td>
                                            <td align="right">
                                                <p><trf-expression value="{$voucher.voucherId}" /></p>
                                            </td>
                                        </tr>
                                    </trf-if>
                                    <trf-if test="{$show_voucher_amount &amp;&amp; isset($voucher.amount)}">
                                        <tr>
                                            <td />
                                            <td>
                                                <p><trf-expression value="{ifset(posbundlestring($$RECEIPT_CUSTOM_BUNDLE_PATH++($card.cardType)++'.VoucherAmount')) ~ posbundlestring($$RECEIPT_BUNDLE_PATH++'VoucherAmount')}" /></p>
                                            </td>
                                            <td align="right">
                                                <p><trf-expression value="{formatnumber($voucher.amount)} {ifset(valueinfo('Currencies', $voucher.currency).title)~''}" /></p>
                                            </td>
                                        </tr>
                                    </trf-if>
                                </trf-if>
                            </trf-if>
                        </trf-foreach>
                        <trf-if test="{$show_number_of_vouchers &amp;&amp; ($voucher_count &gt; 0)}">
                            <tr>
                                <td />
                                <td>
                                    <p><trf-expression value="{ifset(posbundlestring($$RECEIPT_CUSTOM_BUNDLE_PATH++($card.cardType)++'.NumberOfVouchers')) ~ posbundlestring($$RECEIPT_BUNDLE_PATH ++ 'NumberOfVouchers')}" /></p>
                                </td>
                                <td align="right">
                                    <p><trf-expression value="{$voucher_count}" /></p>
                                </td>
                            </tr>
                        </trf-if>
                    </trf-if>
                    <!-- Debit transactions -->
                    <trf-if test="{$show_debits &amp;&amp; isset($card_summary.foreignAmounts.totalDebits)}">
                        <tr>
                            <td />
                            <td>
                                <p><trf-expression value="{ifset(posbundlestring($$RECEIPT_CUSTOM_BUNDLE_PATH++($card.cardType)++'.DebitMutations')) ~ posbundlestring($$RECEIPT_BUNDLE_PATH++'DebitMutations')}" /></p>
                            </td>
                            <td align="right">
                                <p><trf-expression value="{formatprice($card_summary.foreignAmounts.totalDebits)} {$foreign_currency_title}" /></p>
                            </td>
                        </tr>
                    </trf-if>
                    <!-- End balance -->
                    <trf-if test="{$show_end_balance &amp;&amp; isset($card_summary.foreignAmounts.endBalance)}">
                        <tr>
                            <td />
                            <td>
                                <p><trf-expression value="{ifset(posbundlestring($$RECEIPT_CUSTOM_BUNDLE_PATH++($card.cardType)++'.NewBalance')) ~ posbundlestring($$RECEIPT_BUNDLE_PATH++'NewBalance')}" /></p>
                            </td>
                            <td align="right">
                                <p><trf-expression value="{formatprice($card_summary.foreignAmounts.endBalance)} {$foreign_currency_title}" /></p>
                            </td>
                        </tr>
                    </trf-if>
                    <!-- Conversion rate -->
                    <trf-variable name="foreign_currency_description" value="{ifset($document.getCurrencyConverter($card_summary.foreignAmounts.currency).description)}" />
                    <trf-if test="{$show_conversion_rate &amp;&amp; isset($foreign_currency_description)}">
                        <tr>
                            <td />
                            <td colspan="2" align="right">
                                <p><trf-expression value="{$foreign_currency_description}" /></p>
                            </td>
                        </tr>
                    </trf-if>
                </tbody>
            </table>
        </trf-if>
    </trf-template>

    <!--
        ===============
        Payment tickets
        ===============
    -->
    <trf-template name="$TEMPLATE_PAYMENT_TICKETS">
        <trf-if test="{$$RECEIPT_SHOW_PAYMENT_TICKETS}">
            <trf-variable name="first" value="{true}" />
            <trf-foreach name="payment" list="{$document.allPayments}">
                <trf-foreach name="receipt" list="{$payment.receipts}">
                    <trf-if test="{isset($receipt)}">
                        <trf-choose>
                            <trf-when test="{$first}">
                                <trf-variable name="first" value="{false}" />
                                <!--
                                <trf-apply template="$TEMPLATE_EMPTY_LINE" />
                                -->
                            </trf-when>
                            <trf-otherwise>
                                <p/>
                            </trf-otherwise>
                        </trf-choose>
                        <trf-insert object="{$receipt}" unwrap="true" />
                    </trf-if>
                </trf-foreach>
            </trf-foreach>
        </trf-if>
    </trf-template>

    <!--
        =============
        Revised lines
        =============
    -->
    <trf-template name="$z_TEMPLATE_REVISED_LINES">
        <!-- By default revised lines are displayed in separate block -->
        <trf-if test="{ifset($$RECEIPT_SHOW_REVISED_LINES_SEPARATELY)~(!ifset($$RECEIPT_SHOW_REVISED_LINES_IN_ARTICLES)~true)}">
            <trf-variable name="grouped_patch_lines" value="{groupbydatestoreid($document.patchLines, 'creationTimestamp')}" />
            <trf-if test="{count($grouped_patch_lines) &gt; 0}">
                <!--Map all grouped patch lines to the format we want to print in: -->
                <trf-variable name="patch_lines_grouped_for_printing" value="{map()}" />
                <trf-variable name="line_list" value="{list()}" />
                <trf-variable name="previous_store_id_for_date" value="" />
                <trf-foreach name="patch_date" list="{$grouped_patch_lines}">
                    <trf-variable name="formatted_date" value="{formatdate($patch_date,$date_format)}" />
                    <trf-foreach name="line" list="{$grouped_patch_lines.{$patch_date}}">
                        <trf-variable name="store_id" value="{ifset($line.getAttribute('location_code'))}" />
                        <trf-if test="{isset($previous_store_id_for_date) &amp;&amp; ($previous_store_id_for_date != $store_id)}">
                            <trf-variable name="date_location_key" value="{$formatted_date} {$previous_store_id_for_date}"/>
                            <trf-variable name="patch_lines_grouped_for_printing" value="{$patch_lines_grouped_for_printing ++! map($date_location_key, $line_list)}" />
                            <trf-variable name="line_list" value="{list()}"/>
                        </trf-if>
                        <trf-variable name="previous_store_id_for_date" value="{$store_id}" />
                        <trf-variable name="line_list" value="{$line_list +! $line}" />
                    </trf-foreach>
                    <trf-variable name="previous_store_id_for_date" value=""/>
                    <!-- Add stragglers -->
                    <trf-if test="{!isempty($line_list)}">
                        <trf-variable name="date_location_key" value="{$formatted_date} {$store_id}"/>
                        <trf-variable name="patch_lines_grouped_for_printing" value="{$patch_lines_grouped_for_printing ++! map($date_location_key, $line_list)}" />
                        <trf-variable name="line_list" value="{list()}"/>
                    </trf-if>
                </trf-foreach>
                <p><b><trf-expression value="{posbundlestring($$RECEIPT_BUNDLE_PATH ++ 'RevisedLinesTitle',$language)}" /></b></p>
                <trf-variable name="first_patch_date" value="{true}" />
                <trf-variable name="width_description" value="{($$WIDTH_PRINTER - $$RECEIPT_QUANTITY_WIDTH)}" />
                <table width="{$$WIDTH_PRINTER}">
                    <tbody>
                        <trf-foreach name="patch_by_store_date" list="{$patch_lines_grouped_for_printing}">
                            <tr>
                                <td colspan="2" width="{$$WIDTH_PRINTER - $$RECEIPT_AMOUNT_WIDTH}">
                                    <p><b><trf-expression value="{$patch_by_store_date}" /></b></p>
                                </td>
                                <td align ="right" width="{$$RECEIPT_AMOUNT_WIDTH}">
                                    <p><b><trf-expression value="{$document.currency}"/></b></p>
                                </td>
                            </tr>
                            <trf-foreach name="line" list="{$patch_lines_grouped_for_printing.{$patch_by_store_date}}">
                                <trf-variable name="articleCode" value="{$$RECEIPT_ARTICLES_SHOW_SOURCEARTICLECODE?(ifset($line.sourceArticleCode)~($line.articleCode)):($line.articleCode)}" />
                                 <trf-if test="{isset($articleCode) &amp;&amp; ($line.totalQuantity!=0)}">
                                    <tr>
                                        <td width="{$$RECEIPT_QUANTITY_WIDTH}">
                                            <p><trf-expression value="{substring('',0,length($$RECEIPT_FORMAT_ARTICLE_CODE) - length($articleCode))}{$articleCode} " /></p>
                                        </td>
                                        <td width="{$$WIDTH_PRINTER - $$RECEIPT_QUANTITY_WIDTH - $$RECEIPT_AMOUNT_WIDTH}">
                                            <p style="margin-left:{$indent}"><trf-expression value="{isaddon($line)?'+ ':''}{ifset($line.abbrev)~($line.description)}" /></p>
                                        </td>
                                        <td align="right" width="{$$RECEIPT_AMOUNT_WIDTH}">
                                            <p><trf-expression value="{formatnumber($line.unmodifiedAmount.total,$number_format)}" /></p>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td/>
                                        <td>
                                            <p style="margin-left:{$indent}"><trf-expression value="= {$line.totalQuantity} * {iscomponent($line) ? '' : formatnumber($line.price.total,$number_format)}" /></p>
                                        </td>
                                        <td/>
                                    </tr>
                                </trf-if>
                                 <!-- begin change CTCA18050262
                                Look in the XML for a line with the next settings :
                                * related-id= line id of the current line
                                * child-type="add-on"
                                If so, print this article on the receipt, take care, this article has no nagative total, or negative totalQuantity !!
                                This script enhancement is mostly derived from the script above.
                                -->
                                <trf-foreach name="childLine" list="{$line.relatedLine.childLines}">
                                    <trf-if test="{isaddon($childLine)}">
                                        <trf-variable name="childArticleCode" value="{$$RECEIPT_ARTICLES_SHOW_SOURCEARTICLECODE?(ifset($childLine.sourceArticleCode)~($childLine.articleCode)):($childLine.articleCode)}" />
                                        <trf-if test="{isset($childArticleCode) &amp;&amp; ($childLine.totalQuantity!=0)}">
                                            <tr>
                                                <!--
                                                <td width="{$$RECEIPT_QUANTITY_WIDTH}" align="left">
                                                    <p><trf-expression value="{$childLine.totalQuantity}"/></p>
                                                </td>
                                                -->
                                                <td width="{$$RECEIPT_QUANTITY_WIDTH}">
                                                    <p><trf-expression value="{substring('',0,length($$RECEIPT_FORMAT_ARTICLE_CODE) - length($childArticleCode))}{$childArticleCode} " /></p>
                                                </td>
                                                <td width="{$$WIDTH_PRINTER - $$RECEIPT_QUANTITY_WIDTH - $$RECEIPT_AMOUNT_WIDTH}">
                                                    <p style="margin-left:{$indent}"><trf-expression value="{isaddon($childLine)?'+ ':''}{ifset($childLine.abbrev)~($childLine.description)}" /></p>
                                                </td>
                                                <td align="right" width="{$$RECEIPT_AMOUNT_WIDTH}">
                                                    <!-- be aware, this line has NOT a negative total !! -->
                                                    <p><trf-expression value="{formatnumber(-1*($childLine.unmodifiedAmount.total),$number_format)}" /></p>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td/>
                                                <td>
                                                    <!-- be aware, this line has NOT a negative totalQuantity !! -->
                                                    <p style="margin-left:{$indent}"><trf-expression value="= {-1*($childLine.totalQuantity)} * {iscomponent($childLine) ? '' : formatnumber($childLine.price.total,$number_format)}" /></p>
                                                </td>
                                                <td/>
                                            </tr>
                                        </trf-if>
                                    </trf-if>
                                </trf-foreach>
                                <!-- end change CTCA18050262  -->
                            </trf-foreach>
                        </trf-foreach>
                    </tbody>
                </table>
            </trf-if>
        </trf-if>
    </trf-template>

    <!--
        ============
        Footer texts
        ============
    -->
    <trf-template name="$TEMPLATE_FOOTER_TEXTS">
        <trf-if test="{$$RECEIPT_SHOW_FOOTER_TEXTS}">
            <table>
                <tbody>
                    <trf-if test="{isset($print_footer)}">
                        <tr>
                            <td width="{$$WIDTH_PRINTER}" align="{$$RECEIPT_FOOTER_TEXTS_ALIGN}">
                                <trf-apply template="$TEMPLATE_EMPTY_LINE"/>
                                <p><trf-expression value="{$print_footer}" /></p>
                            </td>
                        </tr>
                    </trf-if>
                </tbody>
            </table>
        </trf-if>
    </trf-template>

    <!--
        =======
        Barcode
        =======
    -->
    <trf-template name="$z_TEMPLATE_BARCODE">
        <trf-if test="{$$RECEIPT_SHOW_BARCODE &amp;&amp; !($document.status.waiting) &amp;&amp; !($document.status.void) &amp;&amp; {$document.transactionType != 'z_own_use_m4'} }">
            <trf-variable name="barcode" value="{($document.copy) ? ($document.documentUid) : ($document.printableUid)}" />
            <barcode symbology="{$$RECEIPT_BARCODE_SYMBOLOGY}" data="{$barcode}" width="{ifset($$RECEIPT_BARCODE_WIDTH)~null}" height="{ifset($$RECEIPT_BARCODE_HEIGHT)~null}" />
            <trf-if test="{$$RECEIPT_SHOW_BARCODE_READABLE}">
                <table>
                    <tbody>
                        <tr>
                            <td width="{$$WIDTH_PRINTER}" align="center">
                                <p><trf-expression value="{$barcode}"/></p>
                            </td>
                        </tr>
                    </tbody>
                 </table>
            </trf-if>
        </trf-if>
    </trf-template>

    <!--
        =======
        Short receipt barcode
        =======
    -->
    <trf-template name="$z_TEMPLATE_SHORT_BARCODE">
        <trf-if test="{$$RECEIPT_SHOW_BARCODE &amp;&amp; !($document.status.waiting) &amp;&amp; !($document.status.void) &amp;&amp; {$document.transactionType != 'z_own_use_m4'} }">
            <trf-variable name="barcode" value="{($document.copy) ? ($document.documentUid) : ($document.printableUid)}" />
            <barcode symbology="{$$RECEIPT_BARCODE_SYMBOLOGY}" data="{$barcode}" width="{ifset($$RECEIPT_SHORT_BARCODE_WIDTH)~null}" height="{ifset($$RECEIPT_SHORT_BARCODE_HEIGHT)~null}" />
            <trf-if test="{$$RECEIPT_SHOW_BARCODE_READABLE}">
                <table>
                    <tbody>
                        <tr>
                            <td width="{$$WIDTH_PRINTER}" align="center">
                                <p><trf-expression value="{$barcode}"/></p>
                            </td>
                        </tr>
                    </tbody>
                 </table>
            </trf-if>
        </trf-if>
    </trf-template>

   <!--
        ==========
        Czech republic legal information
        ==========
    -->
    <trf-template name="$z_TEMPLATE_LEGAL_SUMMARY_CZ">
        <trf-if test="{isset($$RECEIPT_LEGAL_SUMMARY_RECORD_TYPE_CZ)}"> <!-- CTCR20010845 -->
            <!-- iterate legal summaries on the document -->
            <trf-foreach name="legalSummary" list="{$document.legalSummaries}">
                <trf-variable name="recordsToBePrinted" value="{list()}" />
                <trf-variable name="legalSummaryType" value="{ifset($legalSummary.type)~''}" />
                <!-- if a czech summary is found iterate its records -->
                <trf-if test="{islegislationtype($legalSummaryType, $$RECEIPT_LEGAL_SUMMARY_RECORD_TYPE_CZ)}">
                    <trf-foreach name="summaryRecord" list="{$legalSummary.summaryRecords}">
                        <trf-variable name="summaryRecordData" value="{split($summaryRecord.data,'\\|')}"/>
                        <!-- check if this summary has to be printed -->
                        <trf-if test="{(count($summaryRecordData)=4) &amp;&amp; ($summaryRecordData[1]='true')}">
                            <trf-variable name="recordsToBePrinted" value="{$recordsToBePrinted ++! list($summaryRecordData)}"/>
                        </trf-if>
                    </trf-foreach>
                </trf-if>
            </trf-foreach>
            <!-- print the record map -->
            <trf-if test="{!isempty($recordsToBePrinted)}">
                <trf-foreach name="printRecord" list="{$recordsToBePrinted}">
                    <table><tbody>
                        <tr>
                            <td width="{integer(16)}" align="left">
                                <trf-variable name="bundlePath" value="{$$CZECH_LEGAL_SUMMARY_BUNDLE_PATH ++ ($printRecord[2])}"/>
                                <p><b><trf-expression value="{posbundlestring($bundlePath, null, $printRecord[2])}"/></b></p>
                            </td>
                            <td width="{integer(26)}" align="left">
                                <p><trf-expression value="{$printRecord[3]}"/></p>
                            </td>
                        </tr>
                    </tbody></table>
                </trf-foreach>
                <table><tbody>
                    <tr>
                        <td width="{integer(16)}" align="left">
                            <trf-variable name="bundlePath" value="{$$CZECH_LEGAL_SUMMARY_BUNDLE_PATH ++ 'ModeLabel'}"/>
                            <p><b><trf-expression value="{posbundlestring($bundlePath, null, 'Mode')}"/></b></p>
                        </td>
                        <td width="{integer(16)}" align="left">
                            <trf-variable name="bundlePath" value="{$$CZECH_LEGAL_SUMMARY_BUNDLE_PATH ++ 'NormalLabel'}"/>
                            <p><trf-expression value="{posbundlestring($bundlePath, null, 'Normal')}"/></p>
                        </td>
                    </tr>
                </tbody></table>
            </trf-if>
        </trf-if> <!-- CTCR20010845 -->
    </trf-template>

    <!--
        ==========
        Italian legal information
        ==========
    -->
    <trf-template name="$TEMPLATE_LEGAL_SUMMARY_IT">
        <trf-if test="{isset($$RECEIPT_LEGAL_SUMMARY_RECORD_TYPE_IT)}">
            <trf-variable name="legislation_type" value="{$$RECEIPT_LEGAL_SUMMARY_RECORD_TYPE_IT}"/>
            <trf-variable name="bundle_path" value="{$$ITALIAN_LEGAL_SUMMARY_BUNDLE_PATH}"/>
            <trf-variable name="has_printed" value="{false}"/>
            <trf-apply template="$GENERIC_LEGAL_SUMMARY_PRINTER"/>
            <!--<trf-if test="{isset($document.displayProperties)}">
               <trf-foreach name="prop" list="{$document.displayProperties}">
                     <trf-variable name="propertyValue" value="{$document.displayProperties.{$prop}.second}"/>
                     <trf-if test="{isset($propertyValue)}">
                          <trf-choose>
                               <trf-when test="{$prop = 'attribute(z_lottery_id)'}">
                                   <p><b><trf-expression value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++'LotteryId',$language)}" /></b> <trf-expression value="{$document.displayProperties.{$prop}.second}"/></p>
                                </trf-when>
                          <trf-otherwise>
                               <p><trf-expression value="{{$document.displayProperties.{$prop}.first} ++ ': ' ++ {$document.displayProperties.{$prop}.second}}"/></p>
                          </trf-otherwise>
                      </trf-choose>
                     </trf-if>
               </trf-foreach>
            </trf-if>
            -->
            <trf-apply template="$TEMPLATE_FISCAL_TRANSACTION_REFERENCE_IT"/>
        </trf-if>
    </trf-template>

    <!--
        ==========
        Italian reference document legal information
        ==========
    -->
    <trf-template name="$TEMPLATE_FISCAL_TRANSACTION_REFERENCE_IT">
        <trf-if test="{isset($$RECEIPT_LEGAL_SUMMARY_RECORD_TYPE_IT)}">
            <trf-variable name="recordsToBePrinted" value="{list()}" />
            <trf-variable name="barcodesToBePrinted" value="{list()}"/>
            <!-- Loop through all attachments and look for a referenced document, if found print the document uid of that document -->
            <trf-foreach name="attachment" list="{$document.attachments}">
                <trf-if test="{'referenced_documents.xbuz'=($attachment.name)}">
                    <trf-variable name="refDocument" value="{xvburead(unzip($attachment.data, true))}" />
                    <trf-foreach name="legalSummary" list="{$refDocument[0].legalSummaries}">
                        <trf-variable name="legalSummaryType" value="{ifset($legalSummary.type)~''}" />
                        <!-- if a matching summary is found iterate its records -->
                        <trf-if test="{islegislationtype($legalSummaryType, $legislation_type)}">
                            <trf-foreach name="summaryRecord" list="{$legalSummary.summaryRecords}">
                                <trf-variable name="summaryRecordData" value="{split($summaryRecord.data,'\\|')}"/>
                                <trf-if test ="{(count($summaryRecordData)=4) &amp;&amp; ($summaryRecordData[2]='FiscalTransactionID')}">
                                    <trf-variable name="refSummaryRecordData" value="'true|true|RefFiscalTransactionID|{$summaryRecordData[3]}"/>
                                    <trf-variable name="recordsToBePrinted" value="{$recordsToBePrinted ++! list(split($refSummaryRecordData,'\\|'))}"/>
                                </trf-if>
                            </trf-foreach>
                        </trf-if>
                    </trf-foreach>
                </trf-if>
            </trf-foreach>
            <trf-apply template="$GENERIC_LEGAL_SUMMARY_PRINT_RECORDS"/>
        </trf-if>
    </trf-template>

    <!--
    ==========
        German legal information
        ==========
    -->
    <trf-template name="$TEMPLATE_LEGAL_SUMMARY_DE">
        <trf-if test="{isset($$RECEIPT_LEGAL_SUMMARY_RECORD_TYPE_DE)}">
            <trf-variable name="legislation_type" value="{$$RECEIPT_LEGAL_SUMMARY_RECORD_TYPE_DE}"/>
            <trf-variable name="bundle_path" value="{$$GERMAN_LEGAL_SUMMARY_BUNDLE_PATH}"/>
            <trf-variable name="has_printed" value="{false}"/>
            <trf-variable name="defaultSymbology" value="{ifset($$RECEIPT_LEGAL_SIGNATURE_DE_BARCODE_SYMBOLOGY)~$$RECEIPT_LEGAL_SIGNATURE_DEFAULT_BARCODE_SYMBOLOGY}"/>
            <trf-variable name="barcodeWidth" value="{ifset($$RECEIPT_LEGAL_SIGNATURE_DE_BARCODE_WIDTH)~(ifset($$RECEIPT_LEGAL_SIGNATURE_DEFAULT_BARCODE_WIDTH)~null)}"/>
            <trf-variable name="barcodeHeight" value="{ifset($$RECEIPT_LEGAL_SIGNATURE_DE_BARCODE_HEIGHT)~(ifset($$RECEIPT_LEGAL_SIGNATURE_DEFAULT_BARCODE_HEIGHT)~null)}"/>
            <trf-apply template="$GENERIC_LEGAL_SUMMARY_PRINTER_2"/>
        </trf-if>
    </trf-template>

    <!--
        ==========
        Generic legal summary printing template
        ==========
    -->
    <trf-template name="$GENERIC_LEGAL_SUMMARY_PRINTER">
        <trf-foreach name="legalSummary" list="{$document.legalSummaries}">
            <trf-variable name="recordsToBePrinted" value="{list()}" />
            <trf-variable name="legalSummaryType" value="{ifset($legalSummary.type)~''}" />
            <!-- if a matching summary is found iterate its records -->
            <trf-if test="{islegislationtype($legalSummaryType, $legislation_type)}">
                <trf-message value="Found legal summary records" />
                <trf-foreach name="summaryRecord" list="{$legalSummary.summaryRecords}">
                    <trf-variable name="summaryRecordData" value="{split($summaryRecord.data,'\\|')}"/>
                    <!-- check if this summary has to be printed -->
                    <trf-message value="Splitted value into {count($summaryRecordData)} printing is {$summaryRecordData[1]}" />
                    <trf-if test="{(count($summaryRecordData)=4) &amp;&amp; ($summaryRecordData[1]='true')}">
                        <trf-variable name="recordsToBePrinted" value="{$recordsToBePrinted ++! list($summaryRecordData)}"/>
                    </trf-if>
                </trf-foreach>
            </trf-if>
        </trf-foreach>
         <trf-apply template="$GENERIC_LEGAL_SUMMARY_PRINT_RECORDS"/>
    </trf-template>

    <trf-template name="$GENERIC_LEGAL_SUMMARY_PRINT_RECORDS">
        <!-- print the record map -->
        <trf-if test="{!isempty($recordsToBePrinted)}">
            <trf-message value="We need to print legal records {$has_printed}" />

            <trf-variable name="has_printed" value="{true}"/>
            <trf-foreach name="printRecord" list="{$recordsToBePrinted}">
                <table><tbody>
                    <tr>
                        <td width="{integer(16)}" align="left">
                            <trf-variable name="bundlePath" value="{$bundle_path ++ ($printRecord[2])}"/>
                            <p><b><trf-expression value="{posbundlestring($bundlePath, null, $printRecord[2])}"/></b></p>
                        </td>
                        <td width="{integer(16)}" align="left">
                            <p><trf-expression value="{$printRecord[3]}"/></p>
                        </td>
                    </tr>
                </tbody></table>
            </trf-foreach>
        </trf-if>
    </trf-template>

<!--
        ==========
        Generic legal summary printing template
        ==========
    -->
    <trf-template name="$GENERIC_LEGAL_SUMMARY_PRINTER_2">
        <trf-variable name="recordsToBePrinted" value="{list()}" />
        <trf-variable name="barcodesToBePrinted" value="{list()}"/>
        <trf-foreach name="legalSummary" list="{$document.legalSummaries}">
            <trf-variable name="legalSummaryType" value="{ifset($legalSummary.type)~''}" />
            <!-- if a matching summary is found iterate its records -->
            <trf-if test="{islegislationtype($legalSummaryType, $legislation_type)}">
                <trf-foreach name="summaryRecord" list="{$legalSummary.summaryRecords}">
                    <trf-variable name="summaryRecordType" value="{$summaryRecord.type}"/>
                    <trf-variable name="summaryRecordData" value="{split($summaryRecord.data,'\\|')}"/>
                    <!-- check if this summary has to be printed -->
                    <trf-if test="{(count($summaryRecordData)=4) &amp;&amp; ($summaryRecordData[1]='true')}">
                        <trf-choose>
                            <trf-when test="{isset($summaryRecordType) &amp;&amp; (startswith($summaryRecordType, 'EAN13_') || startswith($summaryRecordType, 'CODE128_') || startswith($summaryRecordType, 'QRCODE_') || startswith($summaryRecordType, 'PDF417_'))}">
                                <trf-variable name="barcodesToBePrinted" value="{$barcodesToBePrinted ++! list($summaryRecordData)}"/>
                            </trf-when>
                            <trf-otherwise>
                                <trf-variable name="recordsToBePrinted" value="{$recordsToBePrinted ++! list($summaryRecordData)}"/>
                            </trf-otherwise>
                        </trf-choose>
                    </trf-if>
                </trf-foreach>
            </trf-if>
        </trf-foreach>
        <!-- print the record map -->
        <trf-if test="{!isempty($recordsToBePrinted)}">
            <trf-if test="{isset($VAT_NUMBER)}">
                <table>
                    <tbody>
                        <tr>
                            <td width="{integer(16)}" align="left">
                                <p><b><trf-expression value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'VatNr',$language)}"/></b></p>
                            </td>
                            <td width="{integer(16)}" align="left">
                                <p><trf-expression value="{$VAT_NUMBER}"/></p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </trf-if>
            <trf-variable name="has_printed" value="{true}"/>
            <trf-foreach name="printRecord" list="{$recordsToBePrinted}">
                <!-- print the value on a new line if it contains more characters than are available -->
                <trf-variable name="valueLength" value="{length($printRecord[3])}"/>
                <trf-variable name="columnWidth" value="{integer(16)}"/>
                <trf-variable name="valueColumnWidth" value="{$$WIDTH_PRINTER - $columnWidth}"/>
                <trf-variable name="useSingleColumn" value="{($valueLength + $columnWidth) &gt; $$WIDTH_PRINTER}"/>
                <trf-if test="{$useSingleColumn}">
                    <trf-variable name="columnWidth" value="{$$WIDTH_PRINTER}"/>
                    <trf-variable name="valueColumnWidth" value="{$$WIDTH_PRINTER}"/>
                </trf-if>
                <trf-choose>
                    <trf-when test="{$useSingleColumn}">
                        <table><tbody><tr>
                            <td width="{$columnWidth}" align="left">
                                <trf-variable name="bundlePath" value="{$bundle_path ++ ($printRecord[2])}"/>
                                <p><b><trf-expression value="{posbundlestring($bundlePath, null, $printRecord[2])}"/></b></p>
                            </td>
                        </tr><tr>
                            <td width="{$valueColumnWidth}" align="left">
                                <p><trf-expression value="{$printRecord[3]}"/></p>
                            </td>
                        </tr></tbody></table>
                    </trf-when>
                    <trf-otherwise>
                        <table><tbody><tr>
                            <td width="{$columnWidth}" align="left">
                                <trf-variable name="bundlePath" value="{$bundle_path ++ ($printRecord[2])}"/>
                                <p><b><trf-expression value="{posbundlestring($bundlePath, null, $printRecord[2])}"/></b></p>
                            </td>
                            <td width="{$valueColumnWidth}" align="left">
                                <p><trf-expression value="{$printRecord[3]}"/></p>
                            </td>
                        </tr></tbody></table>
                    </trf-otherwise>
                </trf-choose>
            </trf-foreach>
        </trf-if>
        <!-- print the barcode(s) -->
        <trf-if test="{!isempty($barcodesToBePrinted)}">
            <trf-variable name="has_printed" value="{true}"/>
            <trf-foreach name="barcode" list="{$barcodesToBePrinted}">
                <trf-variable name="symbology" value="{ifset($barcode[2])~$defaultSymbology}"/>
                <barcode symbology="{lowercase($symbology)}" data="{$barcode[3]}" width="{$barcodeWidth}" height="{$barcodeHeight}"/>
            </trf-foreach>
        </trf-if>
    </trf-template>


    <!--
        ==========
        Legal Signature
        ==========
    -->
    <trf-template name="$z_TEMPLATE_LEGAL_SIGNATURE_AT">
        <trf-if test="{isset($$RECEIPT_LEGAL_SUMMARY_RECORD_TYPE_AT)}"> <!-- CTCR20010845 -->
            <trf-foreach name="legalSummary" list="{$document.legalSummaries}">
                <!--
                    First build a map for each legal-summary found on the document:
                    Type: Signature, SignatureType, SignatureWarning, SigningDate etc.
                    Data: LegalSummary data belonging to the type.
                -->
                <trf-variable name="summaryRecordMap" value="{map()}" />
                <trf-variable name="summaryRecordsWithTypeFound" value="{false}" />
                <trf-variable name="legalSummaryType" value="{ifset($legalSummary.type)~''}" />
                <trf-if test="{islegislationtype($legalSummaryType, $$RECEIPT_LEGAL_SUMMARY_RECORD_TYPE_AT)}">
                      <trf-foreach name="summaryRecord" list="{$legalSummary.summaryRecords}">
                        <trf-if test="{isset($summaryRecord.type)}">
                            <trf-variable name="summaryRecordType" value="{$summaryRecord.type}"/>
                            <trf-variable name="summaryRecordData" value="{$summaryRecord.data}"/>
                            <trf-variable name="summaryRecordMap" value="{$summaryRecordMap ++! map($summaryRecordType, $summaryRecordData)}"/>
                            <trf-variable name="summaryRecordsWithTypeFound" value="{true}" />
                        </trf-if>
                    </trf-foreach>
                </trf-if>
                <!--
                    Print the legal summary data for each legal summary with a type found on the document.
                -->
                <trf-if test="{$summaryRecordsWithTypeFound}">
                    <table><tbody>
                        <trf-choose>
                            <trf-when test="{$summaryRecordMap.('SignatureType') = {$$RECEIPT_LEGAL_SIGNATURE_TYPE_SHOW_WARNING}}">
                                <tr><td width="{$$WIDTH_PRINTER}" align="{$$RECEIPT_STATE_ALIGN}">
                                    <p><trf-expression value="{$summaryRecordMap.('SignatureWarning')}"/></p>
                                </td></tr>
                            </trf-when>
                            <trf-otherwise>
                                <tr><td width="{$$WIDTH_PRINTER}" align="{$$RECEIPT_STATE_ALIGN}">
                                    <p><trf-expression value="{posbundlestring($$RECEIPT_BUNDLE_PATH ++ 'LegalSignatureTitle')}"/></p>
                                    <trf-variable name="barcodeWidth" value="{ifset($$RECEIPT_LEGAL_SIGNATURE_AT_BARCODE_WIDTH)~null}" />
                                    <trf-variable name="barcodeHeight" value="{ifset($$RECEIPT_LEGAL_SIGNATURE_AT_BARCODE_HEIGHT)~null}" />
                                    <barcode symbology="{$$RECEIPT_LEGAL_SIGNATURE_AT_BARCODE_SYMBOLOGY}" data="{$summaryRecordMap.('Signature')}" width="{$barcodeWidth}" height="{$barcodeHeight}"/>
                                </td></tr>
                            </trf-otherwise>
                        </trf-choose>
                    </tbody></table>
                </trf-if>
            </trf-foreach>
        </trf-if> <!-- CTCR20010845 -->
    </trf-template>




    <!--
        ==========
        Signature
        ==========
    -->
    <trf-template name="$z_TEMPLATE_RECEIPT_SIGNATURE">
       <!-- <trf-if test="{(($document.copy)?$$RECEIPT_SHOW_SIGNATURE_ON_COPY:$$RECEIPT_SHOW_SIGNATURE) &amp;&amp; (ifset($document.getAttribute('receipt_requires_signature'))~false) }">-->
        <trf-if test="{!{$document.status.void}}">
            <table>
                <tbody>
                    <tr>
                        <td width="{$$WIDTH_PRINTER}" align="{$$RECEIPT_SIGNATURE_ALIGN}">
                            <trf-if test="{!{$document.copy}}" >
                                <!-- Overpin-->
                                <trf-if test="{($pin_payment &amp;&amp; $wisselgeld_payment)  &amp;&amp; ($document.transactionType != '' ) &amp;&amp; (isset(posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'transactiontype.' ++ {$document.transactionType} ++ '.SignatureNaam',$language)))}">
                                    <p><trf-expression value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'transactiontype.' ++ {$document.transactionType} ++ '.SignatureNaam',$language)}" /></p>
                                </trf-if>
                                <!-- Exclude documents with zero transaction amount-->
                                <trf-if test="{$document.amount.total &lt; 0}">
                                    <!-- Retourbon Retourpin Dubbelgescan/foute aanslag-->
                                    <trf-if test="{(!{$$displayKlachtSign}) &amp;&amp; ($document.amount.total &lt; 0) &amp;&amp; {$payment.tenderType = 'z_pin'} &amp;&amp; isset(posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'transactiontype.' ++ {$document.transactionType} ++ '.SignatureLeidinggevende',$language))}">
                                        <p><trf-expression value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'transactiontype.' ++ {$document.transactionType} ++ '.SignatureLeidinggevende',$language)}" /></p>
                                    </trf-if>
                                    <!-- Retourbon Retourpin Klacht/verkeerde aangekocht-->
                                    <trf-if test="{{$$displayKlachtSign} &amp;&amp; ($document.amount.total &lt; 0) &amp;&amp; {$payment.tenderType = 'z_pin'} &amp;&amp; isset(posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'transactiontype.' ++ {$document.transactionType} ++ '.SignatureLeidinggevende',$language))}">
                                        <p><trf-expression value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'transactiontype.' ++ {$document.transactionType} ++ '.SignatureLeidinggevende',$language)}" /></p>
                                    </trf-if>
                                    <!-- Retourbon Contant Klacht/verkeerde aangekocht-->
                                    <trf-if test="{{$$displayKlachtSign} &amp;&amp; {$wisselgeld_payment} &amp;&amp; (!{$payment.tenderType = 'z_pin'})&amp;&amp;($document.amount.total &lt; 0) &amp;&amp; isset(posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'transactiontype.' ++ {$document.transactionType} ++ '.SignatureNaam',$language))}">
                                        <p><trf-expression value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'transactiontype.' ++ {$document.transactionType} ++ '.SignatureNaam',$language)}" /></p>
                                        <p><trf-expression value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'transactiontype.' ++ {$document.transactionType} ++ '.SignatureKlant',$language)}" /></p>
                                    </trf-if>
                                    <!-- Retourbon Contant Dubbelgescan/foute aanslag-->
                                    <trf-if test="{{!$$displayKlachtSign} &amp;&amp; {$wisselgeld_payment} &amp;&amp; (!{$payment.tenderType = 'z_pin'})&amp;&amp;($document.amount.total &lt; 0) &amp;&amp; isset(posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'transactiontype.' ++ {$document.transactionType} ++ '.SignatureKlant',$language))}">
                                    <!-- nothing to print-->
                                    </trf-if>
                                </trf-if>
                            </trf-if>
                        </td>
                    </tr>
                    <!-- \/ CTCR20070298 Add text cash receipt customer order -->
                    <trf-if test="{$document.copy}" >
                        <trf-if test="{contains($$RECEIPT_SIGNATURE_DELIVERY_TERMS_TRANSACTION_TYPES, $document.transactionType)}">
                            <tr>
                                <td width="{$$WIDTH_PRINTER}" align="center">
                                    <trf-apply template="$TEMPLATE_EMPTY_LINE"/>
                                    <!-- Terms of delivery -->
                                    <trf-if test="{isset(posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'transactiontype.' ++ {$document.transactionType} ++ '.SignatureDeliveryTerms',$language))}">
                                        <p><trf-expression value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'transactiontype.' ++ {$document.transactionType} ++ '.SignatureDeliveryTerms',$language)}" /></p>
                                    </trf-if>
                                    <trf-if test="{$bilingual}">
                                        <trf-if test="{isset(posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'transactiontype.' ++ {$document.transactionType} ++ '.SignatureDeliveryTerms',$fallback_language))}">
                                            <p><trf-expression value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'transactiontype.' ++ {$document.transactionType} ++ '.SignatureDeliveryTerms',$fallback_language)}" /></p>
                                        </trf-if>
                                    </trf-if>
                                </td>
                            </tr>
                            <tr>
                                <td width="{$$WIDTH_PRINTER}" align="{$$RECEIPT_SIGNATURE_ALIGN}">
                                    <!-- Name customer -->
                                    <trf-if test="{isset(posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'transactiontype.' ++ {$document.transactionType} ++ '.SignatureNaam',$language))}">
                                        <p><trf-expression value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'transactiontype.' ++ {$document.transactionType} ++ '.SignatureNaam',$language)}" /></p>
                                    </trf-if>
                                    <trf-if test="{$bilingual}">
                                        <trf-if test="{isset(posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'transactiontype.' ++ {$document.transactionType} ++ '.SignatureNaam',$fallback_language))}">
                                            <p><trf-expression value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'transactiontype.' ++ {$document.transactionType} ++ '.SignatureNaam',$fallback_language)}" /></p>
                                        </trf-if>
                                    </trf-if>
                                    <!-- Line -->
                                    <trf-if test="{isset(posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'transactiontype.' ++ {$document.transactionType} ++ '.SignatureLine',$language))}">
                                        <p><trf-expression value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'transactiontype.' ++ {$document.transactionType} ++ '.SignatureLine',$language)}" /></p>
                                    </trf-if>
                                    <!-- Customer signature for approval: -->
                                    <trf-if test="{isset(posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'transactiontype.' ++ {$document.transactionType} ++ '.SignatureDeliveryTermsApproved',$language))}">
                                        <p><trf-expression value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'transactiontype.' ++ {$document.transactionType} ++ '.SignatureDeliveryTermsApproved',$language)}" /></p>
                                    </trf-if>
                                    <trf-if test="{$bilingual}">
                                        <trf-if test="{isset(posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'transactiontype.' ++ {$document.transactionType} ++ '.SignatureDeliveryTermsApproved',$fallback_language))}">
                                            <p><trf-expression value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'transactiontype.' ++ {$document.transactionType} ++ '.SignatureDeliveryTermsApproved',$fallback_language)}" /></p>
                                        </trf-if>
                                    </trf-if>
                                    <trf-apply template="$TEMPLATE_EMPTY_LINE"/>
                                    <trf-apply template="$TEMPLATE_EMPTY_LINE"/>
                                </td>
                            </tr>
                        </trf-if>
                    </trf-if>
                    <!-- /\ CTCR20070298 Add text cash receipt customer order -->
                </tbody>
            </table>
        </trf-if>
    </trf-template>

    <!--
        ============
        Page footer
        ============
    -->
    <trf-template name="$TEMPLATE_PAGE_FOOTER">
        <trf-if test="{$$RECEIPT_SHOW_PAGE_FOOTER}">
            <table>
                <tbody>
                    <tr>
                        <td width="{$$WIDTH_PRINTER}">
                            <trf-apply template="$TEMPLATE_SEPARATOR_LINE"/>

                        </td>
                    </tr>
                </tbody>

            </table>
        </trf-if>
    </trf-template>


    <!--
        =============
        Security Seal
        =============
    -->
    <trf-template name="$TEMPLATE_SECURITY_SEAL">
        <trf-if test="{{$$RECEIPT_STATE_SHOW_SECURITY_SEAL} &amp;&amp; ({$document.getPartner('sold_by').country = 'BE'} || {$document.getPartner('sold_by').country = 'FR'})}">
            <table>
                <tbody>
                    <tr>
                        <td width="{$$WIDTH_PRINTER}" align="{$$RECEIPT_STATE_ALIGN}">
                            <p><trf-expression value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++'SecuritySeal',$language)}: {$document.securitySeal}"/></p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </trf-if>
    </trf-template>


    <trf-template name="$z_TEMPLATE_RECEIPT_STATE_COPY">
        <trf-if test="{$$RECEIPT_SHOW_RECEIPT_STATE}">
            <table>
                <tbody>
                    <!-- Document status if relevant -->
                    <trf-if test="{$$RECEIPT_STATE_SHOW_DOCUMENT_STATUS}">
                        <tr>
                            <td width="{$$WIDTH_PRINTER}" align="{$$RECEIPT_STATE_ALIGN}">
                              <!-- <trf-apply template="$TEMPLATE_EMPTY_LINE"/> -->
                                <trf-variable name="document_status" value=""/>
                                <trf-variable name="temp_status" value=""/>
                                <trf-choose>
                                    <trf-when test="{$document.copy}">
                                        <trf-variable name="temp_status" value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'transactiontype.' ++ {$document.transactionType} ++ '.DocumentCopyTitle',$language)}"/>
                                        <trf-if test="{!isset($temp_status)}">
                                            <trf-variable name="temp_status" value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++'DocumentCopyTitle',$language)}"/>
                                        </trf-if>
                                    </trf-when>
                                </trf-choose>
                                <trf-variable name="document_status" value="{$document_status~''++' '}{$temp_status}"/>
                                <trf-if test="{isset($document_status)}">
                                    <p style="font-stretch:normal high;"><trf-expression value="{$document_status}"/></p>
                                </trf-if>
                            </td>
                        </tr>
                    </trf-if>
                </tbody>
            </table>
        </trf-if>
    </trf-template>

      <!--
        ==================================
        Receipt store partner information
        ==================================
    -->
    <trf-template name="$z_TEMPLATE_RECEIPT_STORE_PARTNER_COPY">
                <trf-variable name="setHQText" value="{true}"/>
    <trf-if test="{isset($document.displayProperties)}">
            <trf-foreach name="prop" list="{$document.displayProperties}">
                <trf-variable name="propertyValue" value="{$document.displayProperties.{$prop}.second}"/>
                <trf-if test="{!isset($propertyValue) &amp;&amp; {$prop = 'attribute(z_btw)'} &amp;&amp; {$document.getPartner('sold_by').country != 'CZ'}}">
                    <trf-variable name="setHQText" value="{false}"/>
                </trf-if>
            </trf-foreach>
    </trf-if>
     <trf-variable name="groupCode" value="{substring($document.attributes.location_code,0,1) ++ '000'}"/>
        <!-- document type 'z_invoice' is only used for B2B -->
        <trf-if test="{!{$document.status.void} &amp;&amp; {$setHQText} &amp;&amp; ({$document.getPartner('sold_by').country = 'CZ'} || {$document.documentType = 'z_invoice'})}">
            <table>
                <tbody>
                        <tr>
                            <td width="{$$WIDTH_PRINTER}" align="{$$RECEIPT_STORE_PARTNER_ALIGN_FOOTER}">
                                <trf-if test="{isset(posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'transactiontype.' ++ {$groupCode} ++ '.Address',$language))}">
                                    <p><trf-expression value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'transactiontype.' ++ {$groupCode} ++ '.Address',$language)}"/></p>
                                </trf-if>
                                <p></p>
                            </td>
                        </tr>
                </tbody>
            </table>
        </trf-if>
    </trf-template>

       <!--
        ============
        Page footer
        ============
    -->
    <trf-template name="$z_TEMPLATE_FOOTER_TEXT">
        <trf-if test="{{$$RECEIPT_SHOW_FOOTER_HQ_TEXTS} &amp;&amp; !{$document.status.void} }">
            <trf-variable name="groupCode" value="{substring($document.attributes.location_code,0,1) ++ '000'}"/>
            <trf-variable name="setHQText" value="{true}"/>
            <table>
                <tbody>
                    <tr>
                        <td width="{$$WIDTH_PRINTER}" align="center">
                          <trf-variable name="footer_text" value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'transactiontype.' ++ {$groupCode} ++ '.' ++ {$document.transactionType} ++ '.HQTextBig',$language)}" />
                          <trf-if test="{!isset($footer_text)}">
                            <trf-variable name="footer_text" value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'HQTextBig',$language)}" />
                          </trf-if>
                          <p style="font-stretch:normal high;"><trf-expression value="{$footer_text}"/></p>
                         <trf-if test="{$bilingual}">
                              <trf-variable name="footer_text" value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'transactiontype.' ++ {$groupCode} ++ '.' ++ {$document.transactionType} ++ '.HQTextBig',$fallback_language)}" />
                            <trf-if test="{!isset($footer_text)}">
                              <trf-variable name="footer_text" value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'HQTextBig',$fallback_language)}" />
                            </trf-if>
                            <p style="font-stretch:normal high;"><trf-expression value="{$footer_text}"/></p>
                         </trf-if>
                        </td>
                    </tr>
                    <trf-if test="{isset($document.displayProperties)}">
                        <trf-foreach name="prop" list="{$document.displayProperties}">
                            <trf-variable name="propertyValue" value="{$document.displayProperties.{$prop}.second}"/>
                            <trf-if test="{!isset($propertyValue) &amp;&amp; {$prop = 'attribute(z_btw)'}}">
                                <trf-variable name="setHQText" value="{false}"/>
                            </trf-if>
                        </trf-foreach>
                    </trf-if>
                    <tr>
                        <td width="{$$WIDTH_PRINTER}" align="center">
                          <trf-variable name="footer_text" value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'transactiontype.' ++ {$groupCode} ++ '.' ++ {$document.transactionType} ++ '.HQTextSmall',$language)}" />
                          <trf-if test="{!isset($footer_text)}">
                            <trf-variable name="footer_text" value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'HQTextSmall',$language)}" />
                          </trf-if>
                          <!-- temperarly solution, created issue XV-21339 to implement the function existsposbundlestring, after implementation this function should be used -->
                          <trf-if test="{$footer_text != 'dummy'}">
                          <p><trf-expression value="{$footer_text}"/></p>
                          <trf-if test="{$bilingual}">
                              <trf-variable name="footer_text" value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'transactiontype.' ++ {$groupCode} ++ '.' ++ {$document.transactionType} ++ '.HQTextSmall',$fallback_language)}" />
                            <trf-if test="{!isset($footer_text)}">
                              <trf-variable name="footer_text" value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'HQTextSmall',$fallback_language)}" />
                            </trf-if>
                            <!-- temperarly solution, created issue XV-21339 to implement the function existsposbundlestring, after implementation this function should be used -->
                          <trf-if test="{$footer_text != 'dummy'}">
                            <p><trf-expression value="{$footer_text}"/></p>
                          </trf-if>
                          </trf-if>
                        </trf-if>
                        </td>
                    </tr>
                   <!--
                    <tr>
                        <td>
                            <trf-apply template="$TEMPLATE_EMPTY_LINE"/>
                        </td>
                    </tr>
                    -->
                </tbody>
            </table>
        </trf-if>
    </trf-template>

    <!--
        ============
        Page Header
       ============
    -->
    <trf-template name="$z_TEMPLATE_HEADER_TEXT">
        <trf-if test="{{$$RECEIPT_SHOW_HEADER_HQ_TEXTS} &amp;&amp; !{$document.status.void} }">
            <trf-variable name="groupCode" value="{substring($document.attributes.location_code,0,1) ++ '000'}"/>
            <table>
                <tbody>
                    <tr>
                        <td width="{$$WIDTH_PRINTER}" align="center">
                          <p style="font-stretch:wide high;font:arial;"><b><trf-expression value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++ 'transactiontype.' ++ {$groupCode} ++ '.' ++ {$document.transactionType} ++ '.HQHeaderTextBig',$language)}"/></b></p>
                        </td>
                    </tr>
                    <!--
                    <tr>
                        <td>
                            <trf-apply template="$TEMPLATE_EMPTY_LINE"/>
                        </td>
                    </tr>
                    -->
                </tbody>
            </table>
        </trf-if>
    </trf-template>

    <!--
        ====================
        AUXULIARY TEMPLATES
        ====================
    -->

    <!--
        Auxiliary template for footers and headers - DO NOT CALL DIRECTLY
    -->
    <trf-template name="$TEMPLATE_AUX_HEADERS_FOOTERS">
        <trf-if test="{isset($keys) &amp;&amp; (count($keys) &gt; 0)}">
            <table>
                <tbody>
                    <trf-foreach name="key" list="{$keys}">
                        <trf-variable name="bundleKey" value="{$path ++ $key}" />
                        <trf-if test="{isset(posbundlestring($bundleKey, $language))}">
                            <tr>
                                <td width="{$$WIDTH_PRINTER}" align="{$align}">
                                    <p><trf-expression value="{posbundlestring($bundleKey, $language)}" /></p>
                                    <trf-if test="{$bilingual &amp;&amp; isset(posbundlestring($bundleKey, $fallback_language))}">
                                        <p><trf-expression value="{posbundlestring($bundleKey, $fallback_language)}" /></p>
                                    </trf-if>
                                </td>
                            </tr>
                            <tr><td><trf-apply template="$TEMPLATE_EMPTY_LINE" /></td></tr>
                        </trf-if>
                    </trf-foreach>
                </tbody>
            </table>
        </trf-if>
    </trf-template>

    <!-- Short number of articles -->
    <trf-template name="$TEMPLATE_SHORT_NUMBER_OF_ARTICLES">
        <trf-variable name="total_quantity" value="{0}"/>
        <trf-foreach name="line" list="{$document.lines}">
            <trf-variable name="total_quantity" value="{{$total_quantity} + {$line.totalQuantity}}"/>
        </trf-foreach>
        <table>
            <tbody>
                <tr>
                    <td width="{$$SHORT_RECEIPT_INDENT}"/>
                    <td width="{$$RECEIPT_SHORT_LABEL_WIDTH}">
                        <p>
                            <trf-expression value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++'NumberOfArticles',$language)}: "/>
                        </p>
                    </td>
                    <td width="{$$RECEIPT_SHORT_VALUE_WIDTH}">
                        <p>
                            <trf-expression value="{formatnumber($total_quantity,$quantity_format)}"/>
                        </p>
                    </td>
                </tr>
            </tbody>
        </table>
    </trf-template>

    <!-- Short document completion timestamp -->
    <trf-template name="$TEMPLATE_SHORT_DOCUMENT_COMPLETION_TIMESTAMP">
        <trf-variable name="date" value="{ifset($document.completionTimestamp)}"/>
        <trf-if test="{isset($date)}">
            <table>
                <tbody>
                    <tr>
                        <td width="{$$SHORT_RECEIPT_INDENT}"/>
                        <td width="{$$RECEIPT_SHORT_LABEL_WIDTH}">
                            <p><trf-expression value="{posbundlestring({$$RECEIPT_BUNDLE_PATH} ++'Date',$language)}: " /></p>
                        </td>
                        <td width="{$$RECEIPT_SHORT_VALUE_WIDTH}">
                            <p><trf-expression value="{formatdate($document.completionTimestamp,$datetime_format)}" /></p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </trf-if>
    </trf-template>

    <!-- Short total amount -->
    <trf-template name="$TEMPLATE_SHORT_TOTAL_AMOUNT">
        <trf-apply template="$TEMPLATE_SPLIT_PAYMENTS" />
        <trf-foreach name="modifier" list="{$document.modifiers}">
            <trf-variable name="condition_info" value="{valueinfo('FinancialConditions',$modifier.conditionId)}" />
            <trf-variable name="is_downpayment" value="{ifset(entryinfo($condition_info,'condition_type').enumValue.code = 'payment')~false}" />
            <trf-variable name="is_reservation" value="{ifset(entryinfo($condition_info,'condition_type').enumValue.code = 'reservation')~false}" />
        </trf-foreach>
        <table>
            <tbody>
                <!-- Non-down-payment modifiers and down-payment modifiers handling -->
                <trf-variable name="total_downpayment_amount" value="{0}"/>
                <trf-foreach name="modifier" list="{$document.modifiers}">
                    <trf-variable name="condition_info" value="{valueinfo('FinancialConditions',$modifier.conditionId)}" />
                    <trf-variable name="is_downpayment" value="{ifset(entryinfo($condition_info,'condition_type').enumValue.code = 'payment')~false}" />
                    <trf-variable name="is_reservation" value="{ifset(entryinfo($condition_info,'condition_type').enumValue.code = 'reservation')~false}" />
                    <trf-if test="{$is_downpayment}">
                        <!-- Change the sign of the downpayment amount -->
                        <trf-variable name="total_downpayment_amount" value="{$total_downpayment_amount - ($modifier.amount.total)}"/>
                    </trf-if>
                </trf-foreach>
                <!-- Total -->
                <trf-variable name="total_correction_amount" value="{0}"/>
                <trf-foreach name="payment" list="{$payments_with_full_discount}">
                    <trf-variable name="total_correction_amount" value="{$total_correction_amount + ($payment.amount.total)}"/>
                </trf-foreach>
                <tr>
                    <td width="{$$SHORT_RECEIPT_INDENT}"/>
                    <td width="{$$RECEIPT_SHORT_LABEL_WIDTH}">
                        <p><trf-expression value="{posbundlestring($$RECEIPT_BUNDLE_PATH ++ 'TotalPaid',$language)}: " /></p>
                    </td>
                    <td width="{$$RECEIPT_SHORT_VALUE_WIDTH}">
                        <p><trf-expression value="{formatnumber((($document.totalAmount.total)-$total_correction_amount)+$total_downpayment_amount,$number_format)} {$document.currency}" /></p>
                    </td>
                </tr>
            </tbody>
        </table>
    </trf-template>

     <!--
        ====================
        Customer-specific variant for the store and HQ headers
        ====================
    -->
    <!-- Default HQ headers -->
    <trf-template name="$z_TEMPLATE_HEADER_TEXT_HQ">
        <trf-if test="{{$$RECEIPT_SHOW_HEADER_HQ_EXTRA} &amp;&amp; !{$document.status.void} }">
            <trf-variable name="keys" value="{ifset($$RECEIPT_HQ_HEADERS)~null}" />
            <trf-variable name="path" value="{$$ACTION_RECEIPT_HQ_PATH}" />
            <trf-variable name="align" value="{$$RECEIPT_STORE_HEADER_ALIGN}" />
            <trf-apply template="$TEMPLATE_AUX_HEADERS_FOOTERS" />
        </trf-if>
    </trf-template>

    <!-- Default HQ footer -->
    <trf-template name="$z_TEMPLATE_FOOTER_TEXT_HQ">
        <trf-if test="{{$$RECEIPT_SHOW_FOOTER_HQ_EXTRA} &amp;&amp; !{$document.status.void} }">
        <trf-variable name="keys" value="{ifset($$RECEIPT_HQ_FOOTERS)~null}" />
            <trf-variable name="path" value="{$$ACTION_RECEIPT_HQ_PATH}" />
            <trf-variable name="align" value="{$$RECEIPT_FOOTER_TEXTS_ALIGN}" />
            <trf-apply template="$TEMPLATE_AUX_HEADERS_FOOTERS" />
       </trf-if>
    </trf-template>
</trf-dependencies>